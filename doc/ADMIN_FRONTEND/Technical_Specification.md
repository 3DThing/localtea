# Техническое задание: Admin Frontend (LocalTea)

## 1. Обзор проекта
**Admin Frontend** — это веб-интерфейс для управления платформой LocalTea. Приложение должно предоставлять удобный, быстрый и эстетичный доступ ко всем функциям административного API.
Язык интерфейса: Русский

*   **Цель**: Создать интуитивно понятный инструмент для менеджеров и администраторов, минимизирующий время на выполнение рутинных операций (обработка заказов, наполнение каталога).
*   **URL**: Настраивается через переменные окружения (по умолчанию `http://localhost:3001`).
*   **API URL**: Настраивается через переменные окружения (по умолчанию `http://localhost:8000/api/v1`).

## 2. Технологический стек

### Core
*   **Framework**: [Next.js 14+](https://nextjs.org/) (App Router).
*   **Language**: TypeScript 5+ (Strict mode).
*   **Build Tool**: Turbopack (встроен в Next.js).

### UI & UX
*   **Component Library**: [Mantine v7](https://mantine.dev/).
    *   Использование хуков `@mantine/hooks`.
    *   Использование системы уведомлений `@mantine/notifications`.
    *   Использование дат `@mantine/dates` (Day.js).
*   **Icons**: `tabler-icons-react` (официальный набор для Mantine).
*   **Charts**: `@mantine/charts` (на базе Recharts).
*   **Forms**: `react-hook-form` + `zod` (валидация) + `mantine-form` (опционально, но RHF предпочтительнее для сложной логики).

### State & Data Fetching
*   **Server State**: [TanStack Query v5](https://tanstack.com/query/latest) (React Query).
    *   Кэширование, дедупликация запросов, optimistic updates.
*   **Client State**: [Zustand](https://github.com/pmndrs/zustand) (для глобальных настроек UI: тема, состояние сайдбара).
*   **API Client**: Генерация типизированного клиента из OpenAPI (Swagger) с помощью `openapi-typescript-codegen` или `orval`.

## 3. Архитектура и Структура проекта

Используем принципы **Clean Architecture** и **Feature-Sliced Design** (в упрощенном виде), группируя код по бизнес-фичам, а не по типу файлов.

### Структура директорий
```
src/
├── app/                    # Next.js App Router (Pages & Layouts)
│   ├── (auth)/             # Группа роутов авторизации (login, 2fa)
│   ├── (dashboard)/        # Защищенная зона
│   │   ├── layout.tsx      # Shell (Sidebar, Header)
│   │   ├── page.tsx        # Главный дашборд
│   │   ├── catalog/        # Управление каталогом
│   │   ├── orders/         # Управление заказами
│   │   └── users/          # Управление пользователями
│   └── layout.tsx          # Root Layout (Providers)
├── components/             # Общие UI компоненты (Atomic design)
│   ├── ui/                 # Базовые (Button, Input - если кастомные)
│   ├── layout/             # Sidebar, Header, PageContainer
│   └── shared/             # Переиспользуемые (ConfirmModal, DataTable)
├── features/               # Бизнес-логика (Modules)
│   ├── auth/               # Компоненты и хуки авторизации
│   ├── catalog/            # Логика каталога (ProductForm, CategoryTree)
│   ├── orders/             # Логика заказов (OrderKanban, StatusBadge)
│   └── users/              # Логика пользователей
├── lib/                    # Утилиты и конфигурация
│   ├── api/                # Сгенерированный API клиент
│   ├── axios.ts            # Настроенный инстанс axios (interceptors)
│   └── query-client.ts     # Настройки React Query
├── stores/                 # Глобальные сторы (Zustand)
└── types/                  # Общие типы (если не покрыты генератором)
```

## 4. Дизайн-система и UX

### Темизация
*   **Поддержка тем**: Светлая (Light) и Темная (Dark). Переключатель в хедере.
*   **Цветовая палитра**:
    *   Primary: Зеленый (Teal/Green) — отражает тематику чая.
    *   Danger: Красный — для удалений и блокировок.
    *   Warning: Оранжевый — для статусов "Pending".

### Layout (Оболочка)
*   **Sidebar (Слева)**:
    *   Логотип LocalTea.
    *   Навигационное меню (Dashboard, Catalog, Orders, Users, Settings).
    *   Сворачиваемый режим (только иконки) для малых экранов.
*   **Header (Сверху)**:
    *   Breadcrumbs (Хлебные крошки) для навигации.
    *   Кнопка переключения темы.
    *   Профиль администратора (Avatar + Dropdown: Logout).

### UX Паттерны
*   **Таблицы данных (Data Tables)**:
    *   Должны поддерживать: Пагинацию, Сортировку, Поиск (Debounced input).
    *   Действия в строке: Редактировать, Удалить (с подтверждением).
*   **Формы**:
    *   Валидация на лету (Zod).
    *   Индикация ошибок под полями.
    *   Кнопка "Save" должна показывать состояние загрузки (loading spinner).
*   **Обратная связь**:
    *   Успешные действия -> Зеленый Toast (Notification) в углу.
    *   Ошибки API -> Красный Toast с текстом ошибки.
*   **Модальные окна vs Страницы**:
    *   Простые действия (создание категории, редактирование статуса) -> **Modal/Drawer**.
    *   Сложные действия (создание товара, редактирование товара) -> **Отдельная страница**.

## 5. Функциональные модули

### 5.1. Аутентификация (Auth)
*   **Страница Login**:
    *   Форма: Email, Password.
    *   При успехе: Если сервер возвращает `2fa_required`, переключаем форму на ввод кода.
*   **Ввод 2FA**:
    *   Input для 6 цифр (можно использовать `PinInput` из Mantine).
    *   При успехе: Сохраняем токены, редирект на `/dashboard`.
*   **Настройка 2FA** (для новых админов):
    *   Отображение QR-кода (генерируется из `otpauth_url`).
    *   Поле для ввода кода подтверждения.

### 5.2. Дашборд (Dashboard)
*   **Stat Cards**: 4 карточки сверху (Заказы сегодня, Продажи сегодня, Новые юзеры, Активные сессии).
*   **График продаж**: `AreaChart` (Mantine Charts) показывающий выручку за 30 дней.
*   **Audit Log**: Таблица или список последних 10 действий.
    *   Колонки: Кто, Действие (цветной бейдж), Сущность, Время.

### 5.3. Каталог (Catalog)
**Категории**:
*   Древовидный список или таблица с указанием родителя.
*   CRUD в модальных окнах.

**Товары (Products)**:
*   **Список**: Таблица с миниатюрой изображения, названием, категорией, ценой (диапазон SKU), статусом (Active/Draft).
*   **Создание/Редактирование (Wizard)**:
    1.  **Основное**: Название, Slug (автогенерация из названия), Категория (Select), Описание (Rich Text Editor).
    2.  **Изображения**: Drag & Drop зона. Предпросмотр загруженных, возможность удалить, Drag & Drop для сортировки.
    3.  **SKU (Вариации)**: Список SKU. Возможность добавить/удалить. Поля: Вес, Цена, Скидка, Кол-во.
    4.  **SEO**: Title, Description.

### 5.4. Заказы (Orders)
*   **Список**:
    *   Фильтрация по статусу (Tabs: All, Pending, Paid, Shipped, Cancelled).
    *   Цветовое кодирование статусов.
*   **Детальный просмотр (Drawer или Страница)**:
    *   Информация о клиенте.
    *   Список товаров (Название, SKU, Кол-во, Цена).
    *   Итоговая сумма.
    *   **Управление**:
        *   Кнопки смены статуса (например, "Mark as Shipped").
        *   Кнопка "Cancel Order" (с подтверждением).

### 5.5. Пользователи (Users)
*   **Список**: Таблица пользователей.
*   **Действия**:
    *   Кнопка **"Impersonate"** (Вход под пользователем). При нажатии:
        1.  Вызов API.
        2.  Получение токена.
        3.  Сохранение токена в LocalStorage (под специальным ключом, чтобы не затереть админский, или открытие в инкогнито/новой вкладке - *обсуждаемо, лучше просто открыть User Frontend с этим токеном*).
    *   Сброс 2FA.
    *   Блокировка.

## 6. Интеграция с API (Генерация кода)

Использовать `openapi-typescript-codegen` для автоматического создания сервисов.

1.  **Команда**: `npm run generate-client`
2.  **Источник**: `http://localhost:8000/api/v1/openapi.json`
3.  **Результат**: Типизированные методы, например:
    ```typescript
    // Вместо ручного fetch:
    const { data } = await CatalogService.readProducts({ skip: 0, limit: 10 });
    ```
4.  **React Query Wrapper**: Создать кастомные хуки над сгенерированными методами.
    ```typescript
    export const useProducts = (params) => {
      return useQuery({
        queryKey: ['products', params],
        queryFn: () => CatalogService.readProducts(params)
      });
    };
    ```

## 7. Требования к качеству кода (Clean Code)

1.  **Strict Typing**: Никаких `any`. Все интерфейсы должны совпадать с DTO бэкенда.
2.  **Separation of Concerns**:
    *   Компоненты отвечают только за отображение.
    *   Хуки (`useProducts`) отвечают за получение данных.
    *   Утилиты (`formatCurrency`) отвечают за форматирование.
3.  **DRY (Don't Repeat Yourself)**: Переиспользуемые части форм (например, `PriceInput`) выносить в компоненты.
4.  **Error Handling**: Глобальный обработчик ошибок в Axios interceptor (автоматический логаут при 401, уведомление при 500).

## 8. План разработки (Roadmap)

1.  **Инициализация**: Setup Next.js, Mantine, Axios, React Query. Настройка генератора API.
2.  **Auth Module**: Верстка Login формы, интеграция с API, сохранение JWT.
3.  **App Shell**: Сайдбар, Хедер, переключение тем.
4.  **Users Module**: Таблица пользователей (самое простое для старта).
5.  **Catalog Module**:
    *   Категории (CRUD).
    *   Товары (Таблица).
    *   Форма создания товара (самая сложная часть).
6.  **Orders Module**: Таблица и управление статусами.
7.  **Dashboard**: Графики и статистика.
8.  **Polish**: Улучшение UX, лоадеры, скелетоны, обработка ошибок.

## 9. Конфигурация и Развертывание

### Конфигурация
Все настройки приложения должны быть вынесены в отдельный файл переменных окружения (`.env` или `.env.local`), чтобы обеспечить легкую конфигурируемость без изменения кода.

**Ключевые переменные:**
*   `NEXT_PUBLIC_API_URL`: URL бэкенд API (например, `http://backend:8000/api/v1` или `https://api.example.com/v1`).
*   `NEXT_PUBLIC_FRONTEND_URL`: Публичный URL самого фронтенда (используется для редиректов и ссылок).
*   Другие настройки (таймауты, ключи аналитики и т.д.) также должны быть в `.env`.

### Docker
Фронтенд админки будет запускаться в **отдельном Docker-контейнере**, независимом от бэкенда.

*   **Dockerfile**: Должен использовать multi-stage build для оптимизации размера образа (build stage -> production stage).
*   **Nginx (опционально)**: Внутри контейнера или перед ним может использоваться Nginx для раздачи статики, если не используется встроенный сервер Next.js в standalone режиме (рекомендуется `output: 'standalone'`).
*   **Docker Compose**: Сервис фронтенда должен быть описан в `docker-compose.yml`, с пробросом необходимых портов и переменных окружения.
