# Стресс-тестирование в LocalTea

В этом документе описана методика и инструменты для проведения нагрузочного и стресс-тестирования бэкенда LocalTea.

## Инструмент

Для тестирования используется кастомный скрипт на Python (`scripts/stress_test.py`), использующий библиотеку `httpx` для асинхронной отправки большого количества запросов.

## Запуск теста

Тест запускается внутри контейнера `backend`, так как там уже установлены необходимые зависимости (`httpx`, `asyncio`).

```bash
docker-compose exec backend python scripts/stress_test.py
```

## Конфигурация

Параметры теста задаются в начале файла `scripts/stress_test.py`:

*   **`CONCURRENCY`**: Количество одновременных "пользователей" (потоков). По умолчанию: `100`.
*   **`DURATION_SECONDS`**: Длительность теста в секундах. По умолчанию: `30`.
*   **`ENDPOINTS`**: Список тестируемых эндпоинтов и их веса (вероятность вызова).
    *   `/catalog/products` (60%)
    *   `/catalog/categories` (30%)
    *   `/catalog/products?limit=50&page=1` (10%)

## Результаты и Логи

Скрипт генерирует два файла с отчетами (сохраняются в корне контейнера, т.е. в корне проекта на хосте, благодаря volume mapping):

1.  **`log_stresstest.log`**: Полный лог выполнения.
    *   Содержит записи о каждом запросе (при ошибках) или периодические отчеты о прогрессе.
    *   Формат: `HH:MM:SS - LEVEL - Message`.

2.  **`resultat_stress.log`**: Итоговый отчет.
    *   Содержит сводную статистику по завершении теста.
    *   Пример содержимого:
        ```text
        --- Stress Test Results ---
        Total Requests: 3593
        Duration: 30s
        Average RPS: 119.77
        Status Codes: Counter({200: 3593})
        Avg Latency: 0.8206s
        Median Latency: 0.7251s
        P95 Latency: 2.2386s
        Max Latency: 4.8886s
        ```

## Интерпретация результатов

*   **RPS (Requests Per Second)**: Пропускная способность системы.
*   **P95 Latency**: Время, в которое укладываются 95% запросов. Если это значение высоко (> 1-2 сек), пользователи могут испытывать заметные задержки.
*   **Status Codes**: Наличие кодов отличных от `200` (например, `500`, `502`, `504`) свидетельствует о перегрузке или ошибках сервера.
