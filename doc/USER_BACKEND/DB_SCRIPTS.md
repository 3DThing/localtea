# Работа со скриптами базы данных (миграции, бэкапы, восстановление)

Документ описывает, как пользоваться вспомогательными скриптами в проекте для управления миграциями Alembic и резервными копиями PostgreSQL. Рассчитан на разработчиков и операторов.

Расположение скриптов

- `scripts/db-migrate.sh` — утилита для создания и применения миграций (вызывает `alembic` внутри контейнера `backend`).
- `Makefile` — удобные цели-обёртки: `make db-migrate-new`, `make db-migrate` и т.д.
- `scripts/db-backup.sh` — создание дампа в формате `pg_dump -Fc` и копирование в `./backups/`.
- `scripts/db-restore.sh` — восстановление из дампа через `pg_restore`.

Общие принципы

- Все скрипты рассчитаны на запуск из корня репозитория и используют `docker-compose` (сервис `db` и `backend`).
- По умолчанию имя базы — `localtea` (см. `.env`). Если в вашем окружении другое имя — скорректируйте команды.
- Скрипты упрощают работу, но не заменяют понимания: всегда проверяйте, что вы делаете, особенно при восстановлении (можно потерять данные).

Использование: миграции (Alembic)

Создать новую миграцию (autogenerate):

```bash
# с помощью Makefile
make db-migrate-new m="add promo_code to orders"

# или напрямую
./scripts/db-migrate.sh new "add promo_code to orders"
```

Проверить текущую версию Alembic:

```bash
make db-migrate-current
# или
./scripts/db-migrate.sh current
```

Применить миграции (upgrade head):

```bash
make db-migrate
# или
./scripts/db-migrate.sh upgrade
```

Откатить миграцию (локально, с осторожностью):

```bash
make db-migrate-downgrade rev=-1
# или
./scripts/db-migrate.sh downgrade -1
```

Рекомендации по миграциям

- Всегда просматривайте сгенерированные файлы в `alembic/versions` перед применением.
- Для деструктивных изменений (удаление столбца, изменение типа) используйте многошаговый подход: добавить nullable поле → backfill данных → выставить NOT NULL/constraint.
- Для индексов на больших таблицах используйте `CREATE INDEX CONCURRENTLY` (вручную — не внутри транзакции).
- На продакшне выполняйте миграции в рамках релиз-пайплайна, после создания резервной копии.

Создание резервной копии (backup)

Скрипт `scripts/db-backup.sh` создаёт дамп в формате `pg_dump -Fc` и сохраняет его в `./backups/`.

Примеры:

```bash
# создать бэкап с автоматическим именем
./scripts/db-backup.sh
# или с именем
./scripts/db-backup.sh localtea-20251203.dump
# через Makefile
make db-backup f=localtea-20251203.dump
```

Файлы будут сохранены в каталоге `./backups` в репозитории (рекомендуется добавлять этот каталог в `.gitignore` и копировать бэкапы в защищённое хранилище).

Рекомендации по бэкапам

- Ротация: держите N последних бэкапов (например, 7) и удаляйте старые по расписанию.
- Хранение: копируйте бэкапы на удалённое хранилище (S3/MinIO, NAS) — не держите только в локальном каталоге проекта.
- Размер: для больших баз используйте сжатие (`pg_dump -Fc` уже компактный), отслеживайте свободное место.

Пример cron (раз в день в 02:00, сохранять 7 дней):

```cron
# Запускать в каталоге проекта (пример для crontab):
0 2 * * * cd /path/to/LocalTea && ./scripts/db-backup.sh && find backups/ -type f -mtime +7 -delete
```

Восстановление из дампа (restore)

Скрипт `scripts/db-restore.sh` копирует указанный дамп в контейнер `db` и выполняет `pg_restore`.

```bash
# Восстановление в базу localtea (по умолчанию)
./scripts/db-restore.sh backups/localtea-20251203.dump
# Через Makefile
make db-restore f=backups/localtea-20251203.dump db=localtea
```

Важные замечания при восстановлении

- Восстановление перезапишет объекты в БД (опция `--clean` используется в скрипте). Перед восстановлением убедитесь, что у вас есть актуальный бэкап и что вы действительно хотите перезаписать данные.
- Для восстановления на новую/чистую БД лучше создать свежую базу и восстановить в неё тестово, прежде чем восстанавливать prod.
- Если требуется частичный restore (только определённые таблицы), используйте `pg_restore` с флагами `-t`/`--table` и т.д.

Примеры восстановления отдельных таблиц:

```bash
# внутри контейнера (пример):
pg_restore -U postgres -d localtea -t public.order /tmp/localtea.dump
```

Автоматизация в CI / deploy

- Рекомендуется добавлять шаг в CI/CD, который проверяет, что миграции в репозитории применимы к текущей схеме `alembic current` vs `head`.
- Во время деплоя запускайте `alembic upgrade head` как отдельный шаг после развертывания приложения и перед сменой трафика на новую версию.
- Перед применением миграций в prod выполняйте бэкап базы и (опционально) dry-run на staging.

Пример GitHub Actions snippet (упрощённо):

```yaml
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Apply DB migrations
        run: |
          docker-compose up -d db
          docker-compose exec backend alembic upgrade head
```

Безопасность и лицензии

- Ограничьте доступ к каталогам с бэкапами. Не храните дампы с личными/секретными данными в общедоступных местах.
- Для передачи бэкапов используйте шифрование и защищенные каналы (S3 TLS, SCP по ключам).

Полезные команды диагностики

```bash
# показать контейнеры
docker-compose ps

# подключиться к psql внутри контейнера
docker-compose exec db psql -U postgres -d localtea

# посмотреть логи backend/db
docker-compose logs -f backend
docker-compose logs -f db
```

FAQ / Частые вопросы

Q: "Можно ли запускать скрипт из хоста без Docker?"
A: Скрипты рассчитаны на `docker-compose`. Вы можете адаптировать команды `pg_dump`/`pg_restore` для локального окружения (убрать `docker-compose exec`), если PostgreSQL доступен на хосте.

Q: "Как быстро проверить, что бэкап валидный?"
A: Создайте тестовую базу и выполните `pg_restore --list` или восстановление в тестовую базу, затем выполните простые запросы.

Q: "Скрипты не работают — что проверить?"
- Убедитесь, что контейнер `db` запущен.
- Проверьте имя базы в `.env` и в командах (`localtea`).
- Убедитесь, что у вас достаточно места в `./backups` и в контейнере.

Заключение

В репозитории добавлены удобные скрипты и Makefile-цели для управления миграциями и бэкапами. Они позволяют выстроить безопасный процесс изменения схемы и восстановления данных. Для продакшн-пайплайна рекомендованы дополнительные шаги: offsite-репликация бэкапов, мониторинг и автоматическая ротация старых дампов.
