# API Маршруты (Endpoints) модуля Orders

В этом документе описаны маршруты API для оформления заказов и обработки платежей.
Базовый префикс для всех маршрутов: `/api/v1/orders`.

## Управление заказами

### `POST /checkout`
*   **Описание**: Оформление заказа из текущей корзины.
*   **Требования**: Аутентификация.
*   **Тело запроса**: Пустое (используется текущая корзина пользователя).
*   **Действия**:
    1.  Проверяет наличие товаров на складе.
    2.  Атомарно резервирует товары (уменьшает `quantity` в `SKU`).
    3.  Создает заказ (`Order`) и позиции заказа (`OrderItem`).
    4.  Очищает корзину.
    5.  Инициирует платеж через ЮKassa.
*   **Ответ**: Объект `Order` с `payment_url` для перенаправления пользователя на оплату.

### `GET /`
*   **Описание**: Получение списка заказов текущего пользователя.
*   **Ответ**: Список объектов `Order`.

### `GET /{order_id}`
*   **Описание**: Получение деталей конкретного заказа.
*   **Параметры**: `order_id` (Integer).
*   **Ответ**: Объект `Order` со статусом и списком товаров.

### `POST /{order_id}/cancel`
*   **Описание**: Отмена заказа пользователем.
*   **Условия**: Заказ можно отменить только если он в статусе `awaiting_payment` (Ожидает оплаты).
*   **Действия**:
    1.  Проверяет статус заказа.
    2.  Возвращает зарезервированные товары на склад (увеличивает `quantity`, уменьшает `reserved_quantity` в `SKU`). *Обоснование: Обеспечение точности складского учета при отмене заказа.*
    3.  Помечает связанный платеж как `FAILED`. *Обоснование: Синхронизация статуса платежа со статусом заказа.*
    4.  Перезагружает данные заказа из БД. *Обоснование: Гарантирует, что ответ API содержит актуальные данные, включая вложенные объекты, избегая ошибок валидации.*
*   **Ответ**: Обновленный объект `Order` со статусом `CANCELLED`.

## Webhooks (ЮKassa)

Маршруты для приема уведомлений от платежной системы.
Префикс: `/api/v1/webhooks`.

### `POST /payment/yookassa`
*   **Описание**: Обработка уведомлений о статусе платежа (`payment.succeeded`, `payment.canceled`).
*   **Действия**:
    *   При успехе: Переводит заказ в статус `PAID`.
    *   При отмене: Переводит заказ в статус `CANCELED` и возвращает товары на склад.
*   **Безопасность**: Проверяет IP-адреса ЮKassa (опционально, если настроено).
