# API Маршруты (Endpoints) модуля Orders

В этом документе описаны маршруты API для оформления заказов и обработки платежей.
Базовый префикс для всех маршрутов: `/api/v1/orders`.

## Управление заказами

### `POST /checkout`

*   **Описание**: Оформление заказа из текущей корзины.
*   **Требования**: Аутентификация или session_id.
*   **Тело запроса**: `OrderCheckout`:
    *   `delivery_method` (string): "pickup" или "russian_post".
    *   `contact_info` (object): Данные получателя (firstname, lastname, middlename, phone, email).
    *   `shipping_address` (object, optional): Только для russian_post (postal_code, address).
    *   `delivery_cost_cents` (int): Стоимость доставки в копейках.
    *   `payment_method` (string, default="card"): Способ оплаты.
    *   `promo_code` (string, optional): Промокод для скидки.
*   **Действия**:
    *   Проверяет наличие товаров в корзине.
    *   Проверяет наличие товаров на складе.
    *   Атомарно резервирует товары на складе.
    *   Создает заказ со статусом `AWAITING_PAYMENT`.
    *   Создает позиции заказа (`OrderItem`).
    *   Очищает корзину.
    *   Инициирует платеж через YooKassa.
    *   Создаёт запись `Payment` с `external_id` и `payment_url`.
*   **Ответ**: Объект `OrderResponse` с `payment_url` для редиректа на оплату.

### `GET /`

*   **Описание**: Получение списка заказов текущего пользователя.
*   **Требования**: Аутентификация или session_id.
*   **Ответ**: Список объектов `OrderResponse` (без payment_url), отсортированных по дате (новые первые).

### `GET /{order_id}`

*   **Описание**: Получение деталей конкретного заказа.
*   **Параметры**: `order_id` (Integer).
*   **Особенности**:
    *   Автоматически проверяет статус платежа в YooKassa для заказов со статусом `AWAITING_PAYMENT`.
    *   Если платёж уже оплачен — обновляет статус заказа на `PAID`.
    *   Возвращает `payment_url` для неоплаченных заказов (создаёт новый платёж если старый истёк).
*   **Ответ**: Объект `OrderResponse` с актуальным статусом и `payment_url` (если применимо).

### `POST /{order_id}/cancel`

*   **Описание**: Отмена заказа пользователем.
*   **Условия**: Заказ можно отменить только если он в статусе `AWAITING_PAYMENT`.
*   **Действия**:
    *   Проверяет статус заказа.
    *   Возвращает зарезервированные товары на склад.
    *   Помечает связанный платеж как `FAILED`.
    *   Устанавливает статус заказа `CANCELLED`.
*   **Ответ**: Обновленный объект `OrderResponse` со статусом `CANCELLED`.

### `GET /{order_id}/status`

*   **Описание**: Получить статус оплаты заказа.
*   **Публичный**: Да (для страницы успешной оплаты).
*   **Параметры**: `order_id` (Integer).
*   **Действия**:
    *   Автоматически проверяет статус платежа в YooKassa.
    *   Обновляет статус заказа если платёж подтверждён.
*   **Ответ**: `{"order_id": int, "status": string}`.

---

## Статусы заказа

| Статус | Описание |
|--------|----------|
| `awaiting_payment` | Ожидает оплаты |
| `paid` | Оплачен |
| `processing` | Собирается |
| `shipped` | Передан в доставку |
| `delivered` | Доставлен |
| `cancelled` | Отменён |

---

## Методы доставки

| Метод | Описание | Стоимость |
|-------|----------|-----------|
| `pickup` | Самовывоз | Бесплатно (0) |
| `russian_post` | Почта России | Рассчитывается через API |

---

## Webhooks (YooKassa)

Маршруты для приема уведомлений от платежной системы.
Префикс: `/api/v1/webhooks`.

### `POST /payment/yookassa`

*   **Описание**: Обработка уведомлений о статусе платежа.
*   **События**:
    *   `payment.succeeded` — Платёж успешен.
    *   `payment.canceled` — Платёж отменён.
*   **Действия при payment.succeeded**:
    *   Находит платёж по `external_id`.
    *   Проверяет статус в YooKassa (верификация).
    *   Обновляет статус платежа на `SUCCEEDED`.
    *   Обновляет статус заказа на `PAID`.
    *   Финализирует резерв склада.
*   **Действия при payment.canceled**:
    *   Обновляет статус платежа на `FAILED`.

---

## Модель OrderResponse

*   `id` (int): ID заказа.
*   `status` (string): Статус заказа.
*   `total_amount_cents` (int): Сумма заказа в копейках.
*   `delivery_cost_cents` (int): Стоимость доставки в копейках.
*   `delivery_method` (string): Метод доставки.
*   `tracking_number` (string, optional): Трек-номер (для russian_post).
*   `shipping_address` (object, optional): Адрес доставки.
*   `contact_info` (object): Контактные данные.
*   `created_at` (datetime): Дата создания.
*   `items` (array): Список позиций заказа.
*   `payment_url` (string, optional): Ссылка на оплату (только для AWAITING_PAYMENT).
