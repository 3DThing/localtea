# API Маршруты (Endpoints) модуля Cart

В этом документе описаны маршруты API для работы с корзиной покупок.
Базовый префикс для всех маршрутов: `/api/v1/cart`.

## Идентификация корзины

Корзина привязывается к:
*   **Авторизованному пользователю** — по `user_id`.
*   **Гостю** — по `session_id` (передаётся в заголовке `X-Session-ID`).

При авторизации гостевая корзина автоматически мигрирует к пользователю.

---

## Маршруты

### `GET /`

*   **Описание**: Получение текущей корзины.
*   **Требования**: Аутентификация или session_id.
*   **Параметры запроса**:
    *   `promo_code` (string, optional): Промокод для применения скидки.
*   **Ответ**: Объект `CartResponse`:
    *   `id` (int): ID корзины.
    *   `items` (array): Список позиций корзины.
    *   `total_price` (int): Общая сумма в копейках.
    *   `total_weight_grams` (int): Общий вес в граммах.
    *   `discount_cents` (int, optional): Скидка по промокоду.
    *   `final_price` (int, optional): Итоговая сумма с учётом скидки.
*   **Примечание**: Если корзина не существует, создаётся автоматически.

### `POST /promo`

*   **Описание**: Применить промокод и получить информацию о скидке.
*   **Тело запроса**: `ApplyPromoCode` (code).
*   **Ответ**: `PromoCodeResponse`:
    *   `valid` (bool): Валиден ли промокод.
    *   `discount_cents` (int): Размер скидки в копейках.
    *   `message` (string, optional): Сообщение об ошибке.
*   **Ошибки**:
    *   `400` — Промокод недействителен.

### `POST /items`

*   **Описание**: Добавление товара (SKU) в корзину.
*   **Тело запроса**: `CartItemCreate` (sku_id, quantity).
*   **Действия**:
    *   Проверяет существование SKU.
    *   Проверяет наличие товара на складе.
    *   Если товар уже в корзине — увеличивает количество.
    *   Иначе — добавляет новую позицию.
*   **Ответ**: Обновлённый объект `CartResponse`.
*   **Ошибки**:
    *   `404` — SKU не найден.
    *   `400` — Недостаточно товара на складе.

### `PATCH /items/{item_id}`

*   **Описание**: Обновление количества товара в корзине.
*   **Параметры**: `item_id` (Integer) — ID записи в корзине (не SKU ID).
*   **Тело запроса**: `CartItemUpdate` (quantity).
*   **Действия**:
    *   Проверяет наличие товара на складе.
    *   Обновляет количество.
*   **Ответ**: Обновлённый объект `CartResponse`.
*   **Ошибки**:
    *   `404` — Позиция корзины не найдена.
    *   `400` — Недостаточно товара на складе.

### `DELETE /items/{item_id}`

*   **Описание**: Удаление товара из корзины.
*   **Параметры**: `item_id` (Integer) — ID записи в корзине.
*   **Ответ**: Обновлённый объект `CartResponse`.

### `DELETE /`

*   **Описание**: Полная очистка корзины.
*   **Ответ**: Пустой объект `CartResponse`.

---

## Модели данных

### CartItem

Позиция корзины содержит:
*   `id` (int): ID записи.
*   `sku_id` (int): ID варианта товара.
*   `quantity` (int): Количество.
*   `fixed_price_cents` (int, optional): Фиксированная цена для акций.
*   `sku` (object): Вложенный объект SKU с информацией о товаре.

### Вычисляемые поля корзины

*   `total_price`: Сумма всех позиций (цена × количество).
*   `total_weight_grams`: Сумма веса всех позиций.
