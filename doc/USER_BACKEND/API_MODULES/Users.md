# API Маршруты (Endpoints) модуля Users

В этом документе описаны маршруты API модуля Users.
Базовый префикс для всех маршрутов: `/api/v1/user`.

## Аутентификация и Регистрация

### `POST /registration`

*   **Описание**: Регистрация нового пользователя.
*   **Лимиты**: 5 запросов/минуту, 20 запросов/час.
*   **Тело запроса**: `UserCreate` (email, username, password, firstname, lastname, middlename, address, birthdate).
*   **Действия**:
    *   Проверяет уникальность email и username.
    *   Хеширует пароль (Argon2).
    *   Создает пользователя со статусом `is_active=False`.
    *   Генерирует токен подтверждения email.
    *   Отправляет письмо с ссылкой подтверждения.
*   **Ответ**: Созданный объект пользователя.
*   **Ошибки**: `400` — Email или username уже зарегистрирован.

### `POST /login`

*   **Описание**: Вход в систему.
*   **Лимиты**: 3 запроса/минуту, 20 запросов/час.
*   **Тело запроса**: `UserLogin` (email, password).
*   **Действия**:
    *   Проверяет учётные данные.
    *   Генерирует Access Token (JWT, 30 мин).
    *   Генерирует Refresh Token (UUID, 7 дней).
    *   Генерирует CSRF Token.
    *   Сохраняет сессию в БД.
    *   Устанавливает cookies: `refresh_token` (httpOnly), `csrf_token`.
*   **Ответ**: Объект `Token` (access_token, token_type).

### `POST /login/access-token`

*   **Описание**: OAuth2-совместимый вход (для Swagger UI).
*   **Тело запроса**: `OAuth2PasswordRequestForm` (username, password).

### `POST /logout`

*   **Описание**: Выход из системы.
*   **Требования**: Аутентификация.
*   **Действия**: Аннулирует refresh token, удаляет cookies.

### `POST /refresh`

*   **Описание**: Обновление Access Token.
*   **Требования**: Валидный `refresh_token` в cookies.
*   **Лимиты**: 2 запроса/минуту.
*   **Ответ**: Новый `access_token`.

---

## Подтверждение Email

### `GET /confirm-email`

*   **Описание**: Редирект для подтверждения email (из письма).
*   **Параметры**: `token` (query).
*   **Действия**: Перенаправляет на фронтенд страницу `/confirm-email?token=...`.
*   **Примечание**: Используется для обработки кликов по ссылке из email.

### `POST /confirm-email`

*   **Описание**: Подтверждение email после регистрации.
*   **Параметры**: `token` (query).
*   **Действия**: Валидирует токен, активирует пользователя, устанавливает `email_verified=True`.

### `GET /confirm-email-change`

*   **Описание**: Подтверждение смены email.
*   **Параметры**: `token` (query).
*   **Действия**: Валидирует токен, обновляет email пользователя.

---

## Профиль пользователя

Все маршруты требуют аутентификации и CSRF токена (заголовок `X-CSRF-Token`).

### `GET /get-profile`

*   **Описание**: Получение данных текущего пользователя.
*   **Ответ**: Объект `User` со всеми полями профиля.

### `GET /get-public-profile/{user_id}`

*   **Описание**: Получение публичного профиля пользователя.
*   **Публичный**: Да (не требует аутентификации).
*   **Параметры**: `user_id` (Integer).
*   **Ответ**: Объект с полями:
    *   `username` (string): Имя пользователя.
    *   `avatar_url` (string, optional): URL аватара.
*   **Ошибки**: `404` — Пользователь не найден.

### `POST /change-firstname`

*   **Описание**: Изменение имени.
*   **Тело запроса**: `ChangeFirstname` (firstname).

### `POST /change-lastname`

*   **Описание**: Изменение фамилии.
*   **Тело запроса**: `ChangeLastname` (lastname).

### `POST /change-middlename`

*   **Описание**: Изменение отчества.
*   **Тело запроса**: `ChangeMiddlename` (middlename).

### `POST /change-birthdate`

*   **Описание**: Изменение даты рождения.
*   **Тело запроса**: `ChangeBirthdate` (birthdate).

### `POST /change-address`

*   **Описание**: Изменение адреса.
*   **Тело запроса**: `ChangeAddress` (address).

### `POST /change-postal-code`

*   **Описание**: Изменение почтового индекса.
*   **Тело запроса**: `ChangePostalCode` (postal_code).

### `POST /change-phone-number`

*   **Описание**: Изменение номера телефона.
*   **Тело запроса**: `ChangePhoneNumber` (phone_number).
*   **Примечание**: После смены телефона `phone_verified` сбрасывается в `False`.

### `POST /change-password`

*   **Описание**: Смена пароля.
*   **Тело запроса**: `ChangePassword` (old_password, new_password).

### `POST /change-email`

*   **Описание**: Инициировать смену email.
*   **Тело запроса**: `ChangeEmail` (new_email, password).
*   **Действия**: Отправляет письмо со ссылкой подтверждения на новый email.

### `POST /change-username`

*   **Описание**: Смена username.
*   **Тело запроса**: `ChangeUsername` (new_username).

### `POST /upload-avatar`

*   **Описание**: Загрузка аватара.
*   **Формат**: `multipart/form-data` (file).
*   **Ограничения**: Максимум 5 MB, форматы JPEG/PNG.

---

## Верификация телефона

### `POST /phone-verification/start`

*   **Описание**: Инициировать верификацию телефона.
*   **Требования**: Аутентификация, указан номер телефона.
*   **Действия**: Инициирует звонок на указанный номер.
*   **Ответ**: Маскированный номер телефона.
*   **Ошибки**: `400` — Телефон не указан или уже верифицирован.

### `GET /phone-verification/status`

*   **Описание**: Проверить статус верификации.
*   **Требования**: Аутентификация.
*   **Ответ**: Объект со статусом (`verified`, `pending`, `failed`).

---

## Удаление аккаунта

### `DELETE /account`

*   **Описание**: Удаление аккаунта пользователя.
*   **Тело запроса**: `DeleteAccount` (password).
*   **Действия**:
    *   Проверяет пароль.
    *   Удаляет все сессии.
    *   Удаляет корзину.
    *   Удаляет пользователя.
*   **Ответ**: Сообщение об успешном удалении.
*   **Ошибки**: `400` — Неверный пароль.
