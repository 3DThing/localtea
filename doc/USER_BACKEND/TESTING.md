# Тестирование в LocalTea

В этом документе описана стратегия тестирования проекта, используемые инструменты и подробное описание реализованных тестов.

## Инструменты

*   **Фреймворк**: `pytest`
*   **Асинхронные тесты**: `pytest-asyncio`
*   **HTTP клиент**: `httpx.AsyncClient` (для выполнения запросов к API)
*   **База данных**: PostgreSQL (Временная база данных `localtea_test`, создаваемая для тестов).
*   **Моки (Mocks)**: `unittest.mock` (для заглушки отправки email и других внешних сервисов).

## Запуск тестов

Для запуска всех тестов выполните команду из корня проекта (используя Docker):

```bash
docker-compose exec backend pytest
```

Для запуска с подробным выводом:

```bash
docker-compose exec backend pytest -v
```

> **Важно**: Тесты требуют прав суперпользователя БД для создания тестовой базы данных (`localtea_test`). В среде Docker это настроено автоматически через переменные окружения `POSTGRES_USER` и `POSTGRES_PASSWORD` в `docker-compose.yml`. Если вы запускаете тесты локально (без Docker), убедитесь, что у вас установлены эти переменные окружения.

## Структура тестов

Тесты находятся в директории `tests/`.

### 1. Конфигурация (`tests/conftest.py`)
Этот файл содержит фикстуры (fixtures), которые настраивают окружение перед запуском тестов:
*   **`event_loop`**: Создает и управляет асинхронным циклом событий для каждого теста (`scope="function"`).
*   **`setup_test_database`**: Фикстура с областью видимости `session`, которая создает тестовую БД. Она использует собственный изолированный event loop для выполнения асинхронных операций настройки, чтобы не конфликтовать с event loop'ами тестов (особенность работы `pytest-asyncio` старых версий).
*   **`db_session`**: Создает таблицы во временной базе данных PostgreSQL (`localtea_test`) перед каждым тестом и удаляет их после. Это гарантирует изоляцию тестов друг от друга.
*   **`client`**: Создает экземпляр `AsyncClient`, который отправляет запросы к приложению FastAPI.
*   **`override_get_db`**: Переопределяет зависимость `get_db` в приложении, чтобы оно использовало тестовую БД вместо реальной.
*   **`mock_redis`**: Автоматическая фикстура (`autouse=True`), которая подменяет глобальный клиент Redis на `AsyncMock`. Это необходимо для предотвращения ошибки `RuntimeError: Event loop is closed`, возникающей из-за попытки использования глобального соединения Redis, привязанного к закрытому event loop'у.
*   **Отключение Rate Limiter**: Лимиты запросов отключаются (`limiter.enabled = False`), чтобы тесты не падали из-за ограничений скорости.

### 2. Тесты API Пользователя (`tests/test_user_api.py`)

Этот файл содержит набор интеграционных тестов, проверяющих работу всех эндпоинтов модуля `User`.

#### Фикстуры данных
*   `user_data`: Словарь с данными тестового пользователя (email, password, username и т.д.).
*   `registered_user`: Фикстура, которая регистрирует пользователя перед тестом.
*   `confirmed_user`: Фикстура, которая регистрирует пользователя и подтверждает его email.
*   `auth_headers`: Фикстура, которая выполняет вход (login) и возвращает заголовки авторизации (`Authorization`, `X-CSRF-Token`).

#### Сценарии тестирования

**Обновления тестов (Fixes):**
*   **Cart API Tests**: Обновлены проверки (`assertions`) для соответствия вложенной структуре Pydantic-схем (`item["sku"]["id"]` вместо `item["sku_id"]`). *Обоснование: Тесты должны точно отражать структуру ответа API.*
*   **Order API Tests**: Обновлены моки (`mocks`) для сервиса Yookassa. Теперь они возвращают трансформированную структуру данных (`payment_id`, `payment_url`), которую ожидает сервис заказов, а не сырой ответ внешнего API. *Обоснование: Моки должны симулировать поведение внутренних сервисов-оберток для корректной проверки бизнес-логики.*

### 3. План тестирования новых модулей

Ниже приведен план реализации тестов для модулей Catalog, Cart и Orders.

#### Модуль Catalog (`tests/test_catalog_api.py`)
*   **Цель**: Проверка доступности товаров и категорий для пользователей.
*   **Тесты**:
    *   `test_get_categories`: Получение списка категорий.
    *   `test_get_products_list`: Получение списка товаров с пагинацией.
    *   `test_get_product_detail`: Получение деталей товара и его SKU.
    *   `test_get_sku_detail`: Проверка цены и остатка конкретного SKU.

#### Модуль Cart (`tests/test_cart_api.py`)
*   **Цель**: Проверка логики работы корзины.
*   **Тесты**:
    *   `test_add_item_to_cart`: Добавление товара. Проверка создания корзины.
    *   `test_add_item_insufficient_stock`: Попытка добавить больше товара, чем есть на складе (ожидается 400).
    *   `test_update_cart_item`: Изменение количества.
    *   `test_remove_cart_item`: Удаление товара.
    *   `test_clear_cart`: Полная очистка.

#### Модуль Orders (`tests/test_order_api.py`)
*   **Цель**: Проверка процесса оформления заказа и резервирования.
*   **Тесты**:
    *   `test_checkout_success`: Успешное создание заказа.
        *   Проверка создания записи `Order`.
        *   Проверка уменьшения стока (`sku.quantity`).
        *   Проверка очистки корзины.
    *   `test_checkout_empty_cart`: Попытка заказа с пустой корзиной (ожидается 400).
    *   `test_checkout_race_condition`: (Сложный тест) Симуляция одновременного заказа одного и того же последнего товара двумя пользователями.
    *   `test_cancel_order`: Отмена заказа пользователем -> проверка возврата стока.

#### Интеграционные тесты (End-to-End сценарии)
*   **Полный цикл покупки**:
    1.  Регистрация пользователя.
    2.  Просмотр каталога.
    3.  Добавление в корзину.
    4.  Оформление заказа (Checkout).
    5.  Эмуляция вебхука от ЮKassa (`payment.succeeded`).
    6.  Проверка статуса заказа (`PAID`).


**Регистрация (`/registration`)**
*   `test_register_user_success`: Успешная регистрация. Проверяет, что данные сохранены и вызвана задача отправки email.
*   `test_register_user_duplicate_email`: Попытка регистрации с уже существующим email (Ожидается 400).
*   `test_register_user_duplicate_username`: Попытка регистрации с занятым username (Ожидается 400).
*   `test_register_user_invalid_email`: Валидация формата email (Ожидается 422).
*   `test_register_user_short_password`: Валидация длины пароля (Ожидается 422).

**Аутентификация (`/login`)**
*   `test_login_success`: Успешный вход. Проверяет получение токенов и установку cookies.
*   `test_login_wrong_password`: Вход с неверным паролем (Ожидается 401).
*   `test_login_non_existent_user`: Вход несуществующего пользователя (Ожидается 401).
*   `test_login_unconfirmed_email`: Попытка входа без подтверждения почты (Ожидается 403).

**Подтверждение почты (`/confirm-email`)**
*   `test_confirm_email_success`: Успешное подтверждение по валидному токену.
*   `test_confirm_email_invalid_token`: Попытка подтверждения с неверным токеном (Ожидается 404).

**Профиль (`/get-profile`, `/get-public-profile`)**
*   `test_get_profile_success`: Получение своего профиля (требует авторизации).
*   `test_get_profile_unauthorized`: Доступ без токена (Ожидается 401).
*   `test_get_public_profile_success`: Просмотр публичного профиля другого пользователя.
*   `test_get_public_profile_not_found`: Запрос профиля несуществующего ID (Ожидается 404).

**Редактирование профиля**
*   `test_change_password_success`: Смена пароля и последующий вход с новым паролем.
*   `test_change_password_wrong_old`: Ошибка при вводе неверного старого пароля.
*   `test_change_username_success`: Смена имени пользователя.
*   `test_change_firstname_success`: Смена имени.
*   `test_change_lastname_success`: Смена фамилии.
*   `test_change_middlename_success`: Смена отчества.
*   `test_change_birthdate_success`: Смена даты рождения.
*   `test_change_address_success`: Смена адреса.

**Выход (`/logout`)**
*   `test_logout_success`: Проверяет очистку cookies при выходе.

### 3. Тесты API Взаимодействий (`tests/test_interactions_api.py`)

Этот файл содержит тесты для функционала лайков, комментариев и просмотров.

*   **Цель**: Проверка работы лайков, комментариев и просмотров.
*   **Тесты**:
    *   `test_create_comment_article`: Успешное создание комментария к статье.
    *   `test_create_comment_product`: Успешное создание комментария к товару.
    *   `test_create_comment_invalid`: Попытка комментирования без указания цели или сразу двух целей (400).
    *   `test_get_comments`: Получение списка комментариев.
    *   `test_like_article_auth`: Лайк статьи авторизованным пользователем (toggle).
    *   `test_like_article_anon`: Лайк статьи анонимом (fingerprint).
    *   `test_view_article`: Регистрация просмотра (инкремент счетчика).
    *   `test_report_comment`: Отправка жалобы на комментарий.

### 4. План тестирования новых модулей

Ниже приведен план реализации тестов для модулей Catalog, Cart и Orders.

### 5. Основные тесты (`tests/test_main.py`)
(В данный момент файл может быть пустым или содержать базовые проверки запуска приложения, например, healthcheck, если он есть).

## Особенности реализации

1.  **Изоляция**: Каждый тест работает с чистой базой данных.
2.  **Mocking**: Внешние сервисы (Celery/Redis/Email) заглушаются через `unittest.mock`, чтобы тесты не зависели от инфраструктуры.
3.  **Асинхронность**: Все тесты используют `async/await` для корректной работы с асинхронным движком FastAPI и SQLAlchemy.

## Решение проблем (Troubleshooting)

### RuntimeError: Event loop is closed
Эта ошибка может возникать, если тесты пытаются использовать глобальные асинхронные объекты (например, `redis_client` из `backend/core/cache.py`), которые были инициализированы с event loop'ом, отличным от того, который используется в текущем тесте.

**Решение**:
Используйте фикстуру `mock_redis` (в `conftest.py`), которая подменяет реальный клиент Redis на мок. Это гарантирует, что тесты не будут зависеть от состояния глобального event loop'а.

### Конфликт scope="session" и scope="function"
При использовании `pytest-asyncio` (особенно старых версий) смешивание асинхронных фикстур с разными scope может приводить к ошибкам.

**Решение**:
Для фикстур с `scope="session"` (например, создание БД) используйте синхронную обертку, которая вручную создает и закрывает event loop, как это сделано в `setup_test_database`.

