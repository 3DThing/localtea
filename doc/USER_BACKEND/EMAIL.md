# Модуль отправки электронной почты

В проекте LocalTea реализована система отправки транзакционных писем (подтверждение регистрации, смена пароля и т.д.) с использованием SMTP и HTML-шаблонов.

## Архитектура

Отправка писем вынесена в асинхронный фоновый процесс, чтобы не блокировать основной поток обработки HTTP-запросов пользователя.

1.  **Инициатор**: Сервис (например, `UserService`) формирует данные для письма.
2.  **Планировщик**: Задача отправляется в очередь Celery (`send_email.delay(...)`).
3.  **Брокер**: Redis сохраняет задачу.
4.  **Исполнитель**: Celery Worker забирает задачу из Redis и выполняет её.
5.  **Транспорт**: Модуль `backend/utils/email.py` устанавливает SSL-соединение с SMTP-сервером (например, Yandex, Gmail) и отправляет письмо.

## Конфигурация

Настройки почты задаются в файле `.env`. **Эти данные не должны попадать в репозиторий!**

```ini
# .env
SMTP_SERVER=smtp.yandex.ru
SMTP_PORT=465
SMTP_USER=your_email@yandex.ru
SMTP_PASSWORD=your_app_password  # Пароль приложения, не основной пароль от почты!
EMAILS_FROM_EMAIL=your_email@yandex.ru
EMAILS_FROM_NAME=LocalTea
```

*   **SMTP_PORT**: Используется порт `465` для защищенного SSL соединения (`smtplib.SMTP_SSL`).

## Шаблоны писем

Для формирования тела писем используется шаблонизатор **Jinja2**.
Шаблоны находятся в директории `backend/templates/`.

### Доступные шаблоны

*   **`base.html`**: Базовый шаблон. Содержит общую структуру HTML, стили (CSS) и "фентези" оформление (фон пергамента, шрифты). Определяет блоки `content` и `footer`, которые переопределяются в конкретных письмах.
*   **`verification.html`**: Шаблон письма подтверждения регистрации.
    *   **Переменные контекста**:
        *   `title`: Заголовок письма.
        *   `link`: Ссылка для подтверждения (включает токен).
        *   `token`: Сам токен (для ручного ввода, если требуется).

### Стилизация

Письма оформлены в стиле "Свиток/Фентези":
*   Фон напоминает старую бумагу.
*   Используются шрифты с засечками (Georgia, serif).
*   Кнопки стилизованы под сургучные печати или магические элементы.
*   Адаптивная верстка для корректного отображения на мобильных устройствах.

## Использование в коде

Для отправки письма используйте задачу Celery `send_email`.

```python
from backend.worker import send_email

# ... внутри асинхронной функции ...

send_email.delay(
    email_to="user@example.com",
    subject="Тема письма",
    template_name="verification.html", # Имя файла в backend/templates/
    environment={
        "title": "Добро пожаловать!",
        "link": "http://example.com/confirm?token=...",
        "some_variable": "Значение для шаблона"
    }
)
```

## Отладка

Если письма не приходят:
1.  Проверьте логи контейнера `worker`:
    ```bash
    docker-compose logs -f worker
    ```
2.  Убедитесь, что порты SMTP (465, 587, 25) не заблокированы хостинг-провайдером.
3.  Проверьте правильность учетных данных в `.env`.
4.  Для проверки соединения можно использовать скрипт `backend/debug_smtp.py` (если он есть) или создать простой скрипт с `smtplib`.
