# Документация Admin Backend (LocalTea)

## Обзор
**Admin Backend** — это специализированный сервис для управления платформой LocalTea. Он предоставляет API для администраторов и менеджеров, обеспечивая полный контроль над пользователями, каталогом товаров, заказами и контентом. Сервис работает параллельно с User Backend, используя общую базу данных PostgreSQL, но имеет собственную логику аутентификации и бизнес-процессов.

## Технологический стек

### Бэкенд
*   **Язык программирования**: Python 3.10+
*   **Веб-фреймворк**: FastAPI
*   **Сервер приложений**: Uvicorn
*   **Обработка изображений**: Pillow (для ресайза и конвертации в WebP)

### База данных
*   **СУБД**: PostgreSQL (общая с User Backend)
*   **ORM**: SQLAlchemy + Asyncpg
*   **Миграции**: Alembic (общие миграции в корне проекта)

### Безопасность
*   **Сетевой доступ**: Только через VPN (IP whitelist на уровне Nginx)
*   **Аутентификация**: JWT + Strict 2FA (TOTP)
*   **Шифрование секретов**: Fernet (симметричное шифрование секретов 2FA в БД)
*   **Библиотеки**: `pyotp`, `cryptography`

> ⚠️ **Доступ к Admin Backend и Admin Frontend разрешён только из корпоративной VPN-сети.**

## Архитектура

Сервис `admin_backend` следует той же слоистой архитектуре, что и основной бэкенд, но изолирован в отдельном контейнере.

### Структура директорий (`admin_backend/`)

*   **`api/v1/`**: Маршруты API (Auth, Users, Catalog, Orders, Dashboard).
*   **`core/`**: Настройки безопасности (`security.py` с логикой Fernet), зависимости (`deps.py`).
*   **`crud/`**: Операции с БД, специфичные для админки (например, `crud_admin_2fa`).
*   **`schemas/`**: Pydantic схемы для валидации запросов и ответов админ-панели.
*   **`services/`**: Бизнес-логика:
    *   `audit_log.py`: Сервис логирования действий администраторов.
    *   `image_service.py`: Сервис обработки и оптимизации загружаемых изображений.

## Запуск и Развертывание

Сервис запускается как отдельный контейнер в Docker Compose.

```bash
# Запуск админ-бэкенда
docker-compose up -d admin_backend
```

## Тестирование

Проект покрыт интеграционными и unit-тестами с использованием `pytest`.

*   **Запуск тестов**:
    ```bash
    docker-compose exec admin_backend pytest admin_backend/tests -v
    ```
*   **Покрытие**: Тесты охватывают аутентификацию (включая 2FA), управление пользователями, каталог (CRUD), заказы и дашборд.
*   **Подробнее**: См. [TESTING.md](TESTING.md).

## Документация API

Подробное описание модулей API доступно в папке `API_MODULES`:

*   [Auth](API_MODULES/Auth.md) - Вход и 2FA.
*   [Users](API_MODULES/Users.md) - Управление пользователями.
*   [Catalog](API_MODULES/Catalog.md) - Товары, категории, изображения.
*   [Orders](API_MODULES/Orders.md) - Заказы.
*   [Dashboard](API_MODULES/Dashboard.md) - Статистика.
*   [Blog](API_MODULES/Blog.md) - Управление блогом.
*   [Moderation](API_MODULES/Moderation.md) - Модерация комментариев и жалоб.
*   [PromoCodes](API_MODULES/PromoCodes.md) - Управление промокодами.
*   [Inventory](API_MODULES/Inventory.md) - Управление складом.
*   [Finance](API_MODULES/Finance.md) - Финансовый учёт.
*   [Refunds](API_MODULES/Refunds.md) - Возвраты средств.

## Основные возможности

1.  **Безопасный вход**: Обязательная двухфакторная аутентификация для всех администраторов.
2.  **Управление каталогом**: Создание категорий, товаров, SKU. Загрузка и автоматическая оптимизация изображений.
3.  **Управление заказами**: Просмотр деталей, изменение статусов, отмена.
4.  **Пользователи**: Просмотр списка, редактирование, сброс 2FA, **имперсонация** (вход под пользователем).
5.  **Дашборд**: Статистика продаж, график выручки, лента последних действий (Audit Log).
6.  **Блог**: Создание и редактирование статей с WYSIWYG-редактором, публикация/снятие с публикации.
7.  **Модерация**: Управление комментариями, обработка жалоб, бан пользователей.
8.  **Промокоды**: Создание и управление промокодами с различными типами скидок.
9.  **Склад**: Учёт материалов, остатков товаров, история движений.
10. **Финансы**: Баланс магазина, транзакции, аналитика доходов и расходов.
11. **Возвраты**: Оформление возвратов через YooKassa.
