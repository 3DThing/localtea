# База данных (Изменения для Admin Backend)

Admin Backend использует ту же базу данных PostgreSQL, что и User Backend, но добавляет специфичные таблицы для своих нужд.

## Новые таблицы

### 1. `admin_2fa`
Хранит зашифрованные секреты для двухфакторной аутентификации.

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | Integer (PK) | Идентификатор записи. |
| `user_id` | Integer (FK) | Ссылка на таблицу `user`. |
| `secret` | String | **Зашифрованный** (Fernet) секрет TOTP. |
| `is_enabled` | Boolean | Активирована ли 2FA (True после первого успешного входа). |
| `last_used_at` | DateTime | Время последнего успешного использования (опционально). |

### 2. `admin_action_log`
Журнал аудита действий администраторов.

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | Integer | PK |
| `admin_id` | Integer (FK) | Ссылка на администратора (`user.id`). |
| `action` | String | Тип действия (`create`, `update`, `delete`, `login`, `impersonate`). |
| `entity_id` | Integer | ID затронутой сущности (опционально). |
| `details` | JSONB | Структурированные детали события (например, старые/новые значения). |
| `created_at` | DateTime | Время события. |

### 3. RBAC/роли админов

В фактической схеме присутствуют таблицы для ролей и прав:

- `admin_roles` — роли, описание, `permissions` (JSON), флаги и timestamps.
- `admin_user_roles` — связь many-to-many между админами и ролями.

### 4. Промокоды

- `promo_codes` — хранение промокодов, типов скидок, лимитов использования и периода действия.

### 5. Возвраты

- `refunds` — заявки/операции возврата, связь с заказом, статус, причина, admin_id.

### 6. Склад/инвентаризация

В схеме присутствуют таблицы управления складом и движениями:

- `inventory_categories` — категории материалов
- `inventory_materials` — материалы/сырьё
- `inventory_movements` — движения (приход/расход/корректировки), ссылки на заказ/SKU/админа
- `product_stock` — отдельная таблица остатков SKU (используется модулем инвентаря)

### 7. Финансы

- `finance_transactions` — финансовые операции (тип, сумма, баланс после операции, связи с заказом/админом).

### 8. Настройки магазина

- `store_settings` — ключ-значение параметры (тип, группа, описание, публичность).

## Миграции

Управление схемой осуществляется через **Alembic** из корня проекта.
Миграции для админки находятся в общей папке `alembic/versions`.

*   `xxxx_add_admin_2fa.py`: Создание таблицы `admin_2fa`.
*   `xxxx_add_admin_action_log.py`: Создание таблицы `admin_action_log`.
*   `c3d4e5f6g7h8_add_admin_roles_tables.py`: Роли и связи ролей.
*   `a1b2c3d4e5f6_add_promo_codes_table.py`: Промокоды.
*   `d4e5f6g7h8i9_add_refunds_table.py`: Возвраты.
*   `20251212083330_add_inventory_management.py`: Инвентаризация/склад.
*   `b2c3d4e5f6g7_add_store_settings_table.py`: Настройки магазина.

## Общие модели

Админка активно использует существующие модели:
*   `User` (чтение, редактирование, блокировка).
*   `Order`, `OrderItem` (обработка заказов).
*   `Category`, `Product`, `SKU` (управление каталогом).

## Важно про конфигурацию

В текущей реализации `admin_backend` использует то же подключение к базе данных, что и `backend` (общий `DATABASE_URL` в `.env`).
