# Техническое задание: ADMIN_BACKEND

## 1. Обзор
`ADMIN_BACKEND` — это отдельный микросервис, предназначенный для управления контентом, пользователями и заказами платформы LocalTea. Он предоставляет API для административной панели (фронтенда) и обеспечивает полный контроль над данными `USER_BACKEND`.

Сервис работает в отдельном Docker-контейнере, слушает отдельный порт и использует общую базу данных с `USER_BACKEND`.

## 2. Технологический стек
Стек технологий должен быть унифицирован с основным бэкендом для упрощения поддержки:
*   **Язык**: Python 3.10+
*   **Фреймворк**: FastAPI
*   **БД**: PostgreSQL (подключение к той же БД, что и User Backend)
*   **ORM**: SQLAlchemy + Asyncpg
*   **Валидация**: Pydantic v2
*   **Безопасность**: `pyotp` (для 2FA), `python-jose` (JWT), `passlib` (Argon2)

## 3. Архитектура и Инфраструктура
*   **Тип сервиса**: REST API.
*   **Контейнеризация**: Отдельный сервис в `docker-compose.yml`.
*   **Порт**: Внешний порт, отличный от User Backend (например, `8001`, в то время как User Backend на `8000`).
*   **База данных**: Прямое подключение к основной БД PostgreSQL.
    *   **Стратегия доступа к моделям**: Монорепозиторий. `ADMIN_BACKEND` будет импортировать модели напрямую из `backend.models`.
    *   **Docker Build**: Для решения проблем с импортами в Docker, необходимо настроить `PYTHONPATH` (добавить корень проекта) или копировать директорию `backend/` в контекст сборки контейнера админки.
*   **Кэширование (Redis)**:
    *   Подключение к общему инстансу Redis.
    *   **Инвалидация кэша**: При изменении данных (товары, категории, настройки) `ADMIN_BACKEND` обязан выполнять инвалидацию кэша (удалять ключи), чтобы `USER_BACKEND` отображал актуальную информацию.
*   **Файловое хранилище**: Общий volume для `uploads/` для управления изображениями товаров и блога.

## 4. Безопасность и Аутентификация

### 4.1. Модель Администратора
*   Администраторами считаются пользователи из таблицы `users` с флагом `is_superuser = True`.
*   Для доступа к Admin API **обязательна** двухфакторная аутентификация (2FA).
*   В продакшене так же будет ограничение доступа только через VPN сеть или белые списки.

### 4.2. Процесс входа
1.  **Login (Email + Password)**:
    *   Проверка email и пароля.
    *   Проверка флага `is_superuser`.
    *   Если 2FA не настроена -> Требование настройки (выдача QR-кода).
    *   Если 2FA настроена -> Требование ввода TOTP кода.
    *   Ответ: Временный токен (pre-auth) или инструкция для следующего шага.
2.  **2FA Verification**:
    *   Ввод 6-значного кода из приложения (Google Authenticator, Authy).
    *   Проверка через `pyotp`.
    *   Ответ: Полноценные `access_token` и `refresh_token` с правами администратора.

### 4.3. Реализация 2FA
*   Использовать библиотеку `pyotp`.
*   Секретный ключ TOTP хранить в отдельной таблице `admin_2fa` (не в `users`), чтобы не смешивать логику и позволить в будущем расширить 2FA на обычных пользователей.
*   **Схема таблицы `admin_2fa`**:
    *   `user_id` (ForeignKey -> users.id)
    *   `secret` (String, Encrypted via Fernet) - Шифрование с использованием библиотеки `cryptography` (Fernet). Ключ шифрования должен храниться в переменной окружения `TOTP_ENCRYPTION_KEY`.
    *   `is_enabled` (Boolean)
    *   `last_used_at` (DateTime)

## 5. Функциональные требования (API Modules)

Админ-панель должна предоставлять CRUD (Create, Read, Update, Delete) операции для всех сущностей.

### 5.1. Dashboard (Сводка)
*   Количество новых заказов (за сегодня/неделю).
*   Сумма продаж.
*   **График продаж**: Визуализация продаж за последние 30 дней.
*   Количество новых пользователей.
*   Последние действия (логи из `admin_action_log`).

### 5.2. Управление Пользователями (Users)
*   **Список**: Пагинация, поиск по email/имени, фильтрация по ролям.
*   **Детали**: Просмотр профиля, истории заказов.
*   **Редактирование**:
    *   Блокировка (`is_active = False`).
    *   Назначение администратором (`is_superuser`).
    *   Сброс 2FA (для администраторов).

### 5.3. Каталог (Catalog)
*   **Категории**:
    *   Дерево категорий (Parent/Child).
    *   Загрузка изображений категорий.
    *   SEO поля (Title, Description).
*   **Товары (Products)**:
    *   Полное редактирование (Название, Описание, Lore, Brewing Guide).
    *   SEO поля.
    *   **Изображения**:
        *   Загрузка, удаление, сортировка, выбор главного фото.
        *   **Оптимизация**: При загрузке изображения должны автоматически сжиматься и конвертироваться в формат WebP (используя библиотеку Pillow) для ускорения загрузки на клиенте.
*   **SKU (Торговые предложения)**:
    *   Управление ценами, весом, остатками.
    *   Управление скидками.

### 5.4. Заказы (Orders)
*   **Список**: Фильтр по статусу (Paid, Shipped, etc.), дате, пользователю.
*   **Детали**: Просмотр состава заказа, адреса доставки, контактов.
*   **Управление**:
    *   Смена статуса заказа (например, `AWAITING_PAYMENT` -> `PAID` -> `SHIPPED`).
    *   Добавление трек-номера (если применимо).
    *   Отмена заказа.

### 5.5. Контент (Content)
*   **Блог**: Создание и редактирование статей (Markdown/HTML), загрузка обложек.
*   **Взаимодействия (Interactions)**:
    *   Модерация отзывов и комментариев к товарам.
    *   Возможность скрыть/удалить отзыв.

### 5.6. Настройки (Settings)
*   Управление параметрами системы (если вынесены в БД).
*   Просмотр состояния сервисов (Healthcheck: DB, Redis).

### 5.7. Audit Log (Журнал действий)
*   Критически важно фиксировать, кто и какие изменения вносил в систему.
*   Логировать все операции изменения данных (POST, PATCH, DELETE).
*   **Таблица `admin_action_log`**:
    *   `id` (PK)
    *   `admin_id` (ForeignKey -> users.id)
    *   `action` (String: например, `product.update`, `user.ban`)
    *   `entity_id` (Integer, Nullable: ID измененной сущности)
    *   `details` (JSONB: старые и новые значения, IP адрес)
    *   `created_at` (DateTime)

## 6. План разработки

1.  **Инициализация проекта**:
    *   Создать директорию `admin_backend/`.
    *   Настроить `Dockerfile` и обновить `docker-compose.yml`.
    *   Настроить базовый FastAPI app.
    *   Реализовать CLI команду (например, `make create-superuser`) для создания первого администратора без прямого доступа к БД.
2.  **База данных и Миграции**:
    *   **Стратегия миграций**: Единый источник миграций — `USER_BACKEND` (корневой `alembic`).
    *   Создать новую миграцию в корневом `alembic` для создания таблицы `admin_2fa`.
3.  **Аутентификация**:
    *   Реализовать эндпоинты `/auth/login`, `/auth/2fa/setup`, `/auth/2fa/verify`.
    *   Настроить зависимости (`get_current_admin`).
4.  **Реализация модулей**:
    *   Users CRUD.
    *   Catalog (Categories, Products, SKU) CRUD.
    *   Orders CRUD.
5.  **Тестирование**:
    *   Написание тестов для API.

## 7. Требования к API
*   Все ответы должны быть в формате JSON.
*   Ошибки должны возвращаться с соответствующими HTTP кодами и понятными сообщениями.
*   Документация API (Swagger/OpenAPI) должна быть доступна по адресу `/docs`.

## 8. План API (Endpoints)

Ниже представлен предварительный список эндпоинтов для реализации.

### 8.1. Authentication (`/api/v1/auth`)
*   `POST /login` - Вход по email/password. Возвращает `pre_auth_token` (если 2FA включен) или ошибку.
*   `POST /2fa/setup` - Инициализация 2FA (генерация секрета, возврат QR-кода). Требует `pre_auth_token` (если первый вход) или `access_token`.
*   `POST /2fa/verify` - Подтверждение кода TOTP. Возвращает `access_token` + `refresh_token`.
*   `POST /refresh` - Обновление токена.

### 8.2. Dashboard (`/api/v1/dashboard`)
*   `GET /stats` - Общая статистика (продажи, пользователи, заказы).

### 8.3. Users (`/api/v1/users`)
*   `GET /` - Список пользователей (с пагинацией и фильтрами).
*   `GET /{user_id}` - Детали пользователя.
*   `PATCH /{user_id}` - Обновление Пользовательских данных.
*   `POST /{user_id}/reset_password` - изменение пароля (с отправкой email)
*   `POST /{user_id}/reset_email` - Изменение почты (с отправкой email)
*   `POST /{user_id}/reset-2fa` - Сброс 2FA секрета (только для суперадминов).
*   `POST /{user_id}/impersonate` - Получение временного токена доступа от лица пользователя (для отладки и поддержки).

### 8.4. Catalog (`/api/v1/catalog`)
#### Categories
*   `GET /categories` - Дерево категорий.
*   `POST /categories` - Создать категорию.
*   `PATCH /categories/{id}` - Обновить категорию.
*   `DELETE /categories/{id}` - Удалить категорию.

#### Products
*   `GET /products` - Список товаров.
*   `POST /products` - Создать товар.
*   `GET /products/{id}` - Детали товара (включая SKU и картинки).
*   `PATCH /products/{id}` - Обновить товар.
*   `DELETE /products/{id}` - Удалить (или архивировать) товар.

#### SKU
*   `POST /products/{product_id}/skus` - Добавить SKU.
*   `PATCH /skus/{id}` - Обновить SKU (цена, остаток).
*   `DELETE /skus/{id}` - Удалить SKU.

#### Images
*   `POST /products/{product_id}/images` - Загрузить изображение.
*   `DELETE /images/{id}` - Удалить изображение.
*   `PATCH /images/{id}/reorder` - Изменить порядок/сделать главной.

### 8.5. Orders (`/api/v1/orders`)
*   `GET /` - Список заказов (фильтры: статус, дата).
*   `GET /{id}` - Детали заказа.
*   `PATCH /{id}/status` - Смена статуса.
*   `POST /{id}/cancel` - Отмена заказа.

### 8.6. Content (`/api/v1/content`)
#### Blog
*   `GET /posts` - Список статей.
*   `POST /posts` - Создать статью.
*   `PATCH /posts/{id}` - Обновить статью.
*   `DELETE /posts/{id}` - Удалить статью.

#### Reviews (Interactions)
*   `GET /reviews` - Список отзывов (фильтр: новые/все).
*   `PATCH /reviews/{id}` - Модерация (одобрить/скрыть).
*   `DELETE /reviews/{id}` - Удалить отзыв.

