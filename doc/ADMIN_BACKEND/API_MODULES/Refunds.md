# Модуль Refunds (Admin)

Управление возвратами средств через платёжную систему YooKassa.
Базовый префикс для всех маршрутов: `/api/v1/refunds`.

## Маршруты

### `GET /`

*   **Описание**: Список всех возвратов.
*   **Требования**: Права администратора.
*   **Параметры запроса**:
    *   `skip` (int, default=0): Пропустить N записей.
    *   `limit` (int, default=50, max=200): Лимит записей.
    *   `order_id` (int, optional): Фильтр по заказу.
    *   `status` (string, optional): Фильтр по статусу (`pending`, `succeeded`, `canceled`).
*   **Ответ**: `RefundListResponse` со списком возвратов.

### `GET /order/{order_id}`

*   **Описание**: Информация о возвратах для заказа.
*   **Требования**: Права администратора.
*   **Параметры**: `order_id` (Integer).
*   **Ответ**: `OrderRefundInfo`
    *   `order_id` (int): ID заказа.
    *   `order_total_cents` (int): Общая сумма заказа (товары + доставка).
    *   `total_refunded_cents` (int): Уже возвращённая сумма.
    *   `remaining_refundable_cents` (int): Доступно к возврату.
    *   `refunds` (array): Список возвратов.
    *   `can_refund` (bool): Возможен ли возврат.
    *   `payment_id` (string, optional): ID платежа в YooKassa.

### `POST /`

*   **Описание**: Создать возврат средств.
*   **Требования**: Права администратора.
*   **Тело запроса**: `RefundCreate`
    *   `order_id` (int, required): ID заказа.
    *   `amount_cents` (int, required): Сумма возврата в копейках.
    *   `reason` (string, required): Причина возврата.
    *   `is_full_refund` (bool, default=false): Полный возврат.
*   **Действия**:
    *   Проверяет статус заказа (только `paid`, `shipped`, `delivered`).
    *   Проверяет, что сумма не превышает доступную.
    *   Инициирует возврат через YooKassa API.
    *   Создаёт запись возврата со статусом `pending`.
    *   При полном возврате меняет статус заказа на `refunded`.
    *   Создаёт транзакцию в финансовом учёте.
    *   Записывает действие в аудит лог.
*   **Ответ**: Созданный объект `RefundResponse`.
*   **Ошибки**:
    *   `404` — Заказ не найден.
    *   `400` — Невозможно вернуть средства (неподходящий статус, превышение суммы).

### `GET /{refund_id}/status`

*   **Описание**: Проверить статус возврата в YooKassa.
*   **Требования**: Права администратора.
*   **Параметры**: `refund_id` (Integer).
*   **Действия**:
    *   Запрашивает актуальный статус в YooKassa.
    *   Обновляет локальный статус при необходимости.
*   **Ответ**: Актуальный статус возврата.

---

## Статусы возвратов

| Статус | Описание |
|--------|----------|
| `pending` | Ожидает обработки в YooKassa |
| `succeeded` | Успешно возвращено |
| `canceled` | Возврат отменён |

---

## Условия для возврата

Возврат возможен, если:
*   Заказ в статусе `paid`, `shipped` или `delivered`.
*   Есть успешный платёж (`payment_id` не null).
*   Остаток к возврату больше нуля.

---

## Модель данных RefundResponse

*   `id` (int): ID возврата.
*   `order_id` (int): ID заказа.
*   `payment_id` (string): ID платежа.
*   `refund_id` (string): ID возврата в YooKassa.
*   `amount_cents` (int): Сумма возврата в копейках.
*   `reason` (string): Причина возврата.
*   `status` (string): Статус.
*   `admin_id` (int): ID администратора, создавшего возврат.
*   `created_at` (datetime): Дата создания.
*   `updated_at` (datetime, optional): Дата обновления.

---

## Интеграция с финансами

При успешном возврате автоматически создаётся транзакция:
*   **Тип**: `REFUND`
*   **Сумма**: Отрицательная (уменьшает баланс)
*   **Описание**: "Возврат по заказу #{order_id}"
