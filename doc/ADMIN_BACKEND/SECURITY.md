# Безопасность Admin Backend

## Двухфакторная аутентификация (2FA)

В отличие от пользовательского приложения, доступ к админ-панели защищен обязательной двухфакторной аутентификацией (TOTP).

### Реализация
1.  **Библиотека**: `pyotp` используется для генерации и проверки кодов.
2.  **Хранение секретов**: Секретные ключи TOTP **не хранятся** в открытом виде.
    *   Используется симметричное шифрование **Fernet** (библиотека `cryptography`).
    *   Ключ шифрования берется из переменной окружения `SECRET_KEY`.
    *   При компрометации базы данных злоумышленник не сможет сгенерировать коды 2FA без ключа приложения.

### Процесс входа
1.  **Фаза 1 (Login)**: Администратор вводит email и пароль.
    *   Если верно -> Сервер возвращает `temp_token` (JWT с типом `pre_auth`) и состояние `2fa_required` (или `2fa_setup_required`).
2.  **Фаза 2 (Verify)**: Администратор вводит код из приложения-аутентификатора.
    *   Клиент отправляет `temp_token` + `code`.
    *   Сервер расшифровывает секрет из БД, проверяет код.
    *   Если верно -> Сервер выдает полноценные `access_token` и `refresh_token`.

## Имперсонация (Impersonation)

Администраторы (Superuser) имеют возможность войти в систему под любым пользователем для отладки проблем.

*   **Endpoint**: `POST /api/v1/users/{id}/impersonate`
*   **Механизм**:
    1.  Администратор отправляет запрос с ID целевого пользователя.
    2.  Сервер генерирует валидные `access_token` и `refresh_token` для этого пользователя.
    3.  В **Audit Log** делается запись о факте имперсонации.
*   **Ограничения**: Доступно только пользователям с флагом `is_superuser`.

## Audit Log (Журнал действий)

Все критические действия администраторов логируются в таблицу `admin_action_log`.

*   **Что логируется**:
    *   Вход в систему (через выдачу токенов).
    *   Создание/Редактирование/Удаление сущностей (Товары, Категории, Пользователи).
    *   Изменение статусов заказов.
    *   Имперсонация.
*   **Структура лога**:
    *   `admin_id`: Кто совершил действие.
    *   `action`: Тип действия (create, update, delete, impersonate).
    *   `entity_type`: Тип сущности (product, order, user).
    *   `entity_id`: ID сущности.
    *   `details`: JSON с подробностями (например, "Updated status to PAID").
