# История изменений (Admin Backend Implementation)

## [1.1.0] - 2025-12-05

### Добавлено

#### Инфраструктура
*   Настроен **NGINX** как reverse proxy с SSL сертификатами Let's Encrypt.
*   Домены:
    *   `api.localtea.ru` — клиентский API (публичный).
    *   `apiadmin.localtea.ru` — админский API (ограничен по IP).
    *   `admin.localtea.ru` — фронтенд админки (ограничен по IP).
*   Ограничение доступа к админским ресурсам по IP (белый список).

#### Блог
*   Полный CRUD для статей блога (`/api/v1/blog/`).
*   Публикация/снятие с публикации статей.
*   Загрузка изображений с конвертацией в WebP.
*   Интеграция с WYSIWYG редактором TipTap на фронтенде.

### Исправлено
*   Исправлена обработка ValidationError (bytes → string для JSON сериализации).
*   Добавлен MIME type `image/webp` для корректной отдачи изображений.
*   Обновлены CORS настройки для работы с новыми доменами.

---

## [1.0.0] - 2025-12-04

Первый релиз функционала административной панели.

### Добавлено

#### Инфраструктура
*   Создан новый сервис `admin_backend` в `docker-compose.yml` (порт 8001).
*   Настроен `Dockerfile` с поддержкой библиотеки `Pillow` для обработки изображений.

#### База данных
*   Добавлена таблица `admin_2fa` для хранения секретов двухфакторной аутентификации.
*   Добавлена таблица `admin_action_log` для аудита действий.
*   Созданы соответствующие миграции Alembic.

#### Безопасность
*   Реализована **Strict 2FA**:
    *   Использование `pyotp` для TOTP.
    *   Шифрование секретов в БД алгоритмом **Fernet**.
    *   Трехэтапный процесс входа (Login -> Temp Token -> Verify -> Access Token).
*   Реализована **Имперсонация**:
    *   Суперпользователь может получить валидный токен любого пользователя для отладки.

#### API Модули
*   **Auth**: Вход, настройка и проверка 2FA.
*   **Users**: Просмотр списка, поиск, редактирование, сброс 2FA.
*   **Catalog**:
    *   Полный CRUD для Категорий, Товаров и SKU.
    *   Загрузка изображений с автоматической конвертацией в WebP и ресайзом.
*   **Orders**: Просмотр заказов и изменение статусов.
*   **Dashboard**: Агрегированная статистика (продажи, заказы, пользователи) и график продаж.

#### Сервисы
*   `audit_log.py`: Асинхронный сервис для записи действий администраторов в БД.
*   `image_service.py`: Сервис для обработки загружаемых файлов (Pillow).

### Изменено (в User Backend контексте)
*   Обновлен `docker-compose.yml` для включения нового сервиса.
*   В `backend/core/security.py` добавлена утилита `create_refresh_token_str`, необходимая для обоих сервисов.
