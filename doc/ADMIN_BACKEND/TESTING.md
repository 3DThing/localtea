# План тестирования Admin Backend

Этот документ описывает стратегию тестирования административной панели LocalTea. Тесты покрывают основные сценарии использования, безопасность и обработку ошибок.

## Инструменты
*   **Фреймворк**: `pytest`
*   **Асинхронность**: `pytest-asyncio`
*   **HTTP Клиент**: `httpx.AsyncClient`
*   **База данных**: Тестовая БД PostgreSQL (создается/очищается фикстурами).

## Сценарии тестирования

### 1. Аутентификация (Auth)
*   **POST /login**
    *   [+] Успешный вход (правильный email/password). Проверка статуса `2fa_setup_required` или `2fa_required`.
    *   [-] Неверный пароль.
    *   [-] Вход пользователем без прав администратора (`is_superuser=False`).
*   **POST /2fa/setup**
    *   [+] Успешная генерация секрета (валидный `temp_token`).
    *   [-] Невалидный или просроченный токен.
*   **POST /2fa/verify**
    *   [+] Успешная верификация кода. Получение `access_token`.
    *   [-] Неверный код TOTP.
    *   [-] Попытка верификации без предварительного `setup` (если применимо).

### 2. Управление пользователями (Users)
*   **GET /users/**
    *   [+] Получение списка (проверка пагинации).
    *   [+] Фильтрация по email.
*   **PATCH /users/{id}**
    *   [+] Блокировка пользователя (`is_active=False`).
    *   [-] Редактирование несуществующего пользователя (404).
*   **POST /users/{id}/reset-2fa**
    *   [+] Сброс 2FA для пользователя.
    *   [-] Сброс для пользователя, у которого нет 2FA.
*   **POST /users/{id}/impersonate**
    *   [+] Получение токена пользователя (Superuser).
    *   [-] Попытка имперсонации обычным админом (если права разделены, пока только superuser).

### 3. Каталог (Catalog)
*   **Categories**
    *   [+] Создание категории.
    *   [+] Обновление категории.
    *   [+] Удаление категории.
*   **Products**
    *   [+] Создание товара.
    *   [-] Создание товара с несуществующей категорией (400).
    *   [+] Обновление товара (изменение цены, описания).
    *   [+] Удаление товара.
*   **SKU**
    *   [+] Добавление SKU к товару.
    *   [-] Добавление SKU к несуществующему товару.
*   **Images**
    *   [+] Загрузка изображения (Mock `image_service`).

### 4. Заказы (Orders)
*   **GET /orders/{id}**
    *   [+] Получение деталей заказа.
    *   [-] Заказ не найден.
*   **PATCH /orders/{id}/status**
    *   [+] Смена статуса на `PAID`.
    *   [+] Смена статуса на `SHIPPED`.
    *   [-] Обновление несуществующего заказа (404).
*   **POST /orders/{id}/cancel**
    *   [+] Отмена заказа.

### 5. Дашборд (Dashboard)
*   **GET /dashboard/stats**
    *   [+] Получение структуры данных (проверка ключей `orders`, `sales`, `users`, `logs`).

### 6. Безопасность (Security)
*   [-] Доступ к защищенным эндпоинтам без токена (401).
*   [-] Доступ с токеном обычного пользователя (403).
