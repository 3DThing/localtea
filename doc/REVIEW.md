# –ü–æ–ª–Ω—ã–π —Ä–µ–≤—å—é –∫–æ–¥–∞ –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞ LocalTea

> **–î–∞—Ç–∞ —Ä–µ–≤—å—é:** —Ñ–µ–≤—Ä–∞–ª—å 2026  
> **–Ø–∑—ã–∫:** Python 3.10 (FastAPI), TypeScript (Next.js 16)  
> **–°—Ç–∞—Ç—É—Å:** –ø—Ä–æ–µ–∫—Ç –≤ —Å—Ç–∞–¥–∏–∏ –∞–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, **–Ω–µ –≥–æ—Ç–æ–≤ –∫ production-—Ä–µ–ª–∏–∑—É**

---

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞](#1-–æ–±—â–∞—è-–æ—Ü–µ–Ω–∫–∞-–ø—Ä–æ–µ–∫—Ç–∞)
2. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑](#2-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π-–∞–Ω–∞–ª–∏–∑)
3. [–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã)](#3-–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ-–±–∞–≥–∏-–∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã)
4. [–£—è–∑–≤–∏–º–æ—Å—Ç–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã)](#4-—É—è–∑–≤–∏–º–æ—Å—Ç–∏-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏-–∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã)
5. [–ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)](#5-–∫–∞—á–µ—Å—Ç–≤–æ-–∫–æ–¥–∞-–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
6. [–ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (—Ç—Ä–µ–±—É—é—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)](#6-–∏–∑–≤–µ—Å—Ç–Ω—ã–µ-–ø—Ä–æ–±–ª–µ–º—ã-—Ç—Ä–µ–±—É—é—Ç-–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
7. [–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ä–µ–ª–∏–∑—É](#7-–≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å-–∫-—Ä–µ–ª–∏–∑—É)
8. [–ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π](#8-–ø–ª–∞–Ω-–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π)

---

## 1. –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞

**–û—Ü–µ–Ω–∫–∞: 6/10**

LocalTea ‚Äî —ç—Ç–æ –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π e-commerce –ø—Ä–æ–µ–∫—Ç –ø–æ –ø—Ä–æ–¥–∞–∂–µ —á–∞—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º —Ä—ã–Ω–∫–µ. –°—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –≤—ã–±—Ä–∞–Ω —Ä–∞–∑—É–º–Ω–æ –∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ: FastAPI, PostgreSQL, Redis, Celery, Next.js. –ü—Ä–æ–µ–∫—Ç –∏–º–µ–µ—Ç —Ö–æ—Ä–æ—à—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –≤–∫–ª—é—á–∞–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é —á–µ—Ä–µ–∑ JWT + CSRF + TOTP-2FA –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å –ÆKassa –¥–ª—è –æ–ø–ª–∞—Ç—ã, –ü–æ—á—Ç–æ–π –†–æ—Å—Å–∏–∏ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏, –∏ sms.ru –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞.

**–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:**
- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ –±—ç–∫–µ–Ω–¥–æ–≤
- –î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (TOTP) –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
- HMAC-–ø–æ–¥–ø–∏—Å—å –∏ IP-–≤–∞–π—Ç–ª–∏—Å—Ç –¥–ª—è webhook'–æ–≤ –ÆKassa
- –†–æ—Ç–∞—Ü–∏—è refresh-—Ç–æ–∫–µ–Ω–æ–≤ —Å —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ö–µ—à–∞ –≤ –ë–î
- –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π —á–µ—Ä–µ–∑ Argon2 (–ª—É—á—à–∏–π –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –∞–ª–≥–æ—Ä–∏—Ç–º)
- –ó–∞—â–∏—Ç–∞ CSRF –¥–ª—è state-changing –æ–ø–µ—Ä–∞—Ü–∏–π
- Rate limiting (slowapi) –Ω–∞ –∫–ª—é—á–µ–≤—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞—Ö
- Honeypot-—Å–µ—Ä–≤–∏—Å –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∞—Ç–∞–∫
- –¢–µ—Å—Ç—ã –¥–ª—è –∫–ª—é—á–µ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
- Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏—è —Å —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º dev/prod –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
- Non-root –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ production-–æ–±—Ä–∞–∑–µ (UID 10001)

**–°–ª–∞–±—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã (–≤–æ—à–ª–∏ –≤ –ø–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π):**
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏, —Å–ø–æ—Å–æ–±–Ω—ã–µ –≤—ã–∑–≤–∞—Ç—å `NameError` –≤ production
- –†—è–¥ —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –±–µ–∑ rate limiting
- OpenAPI/Swagger –æ—Ç–∫—Ä—ã—Ç –≤ production
- –ù–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ª–∏–º–∏—Ç–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –°–æ—Å—Ç–æ—è–Ω–∏–µ –≥–æ–Ω–∫–∏ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞
- –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ (—Ö—Ä–∞–Ω–∏–ª–∏—â–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ –≤ –¥–≤—É—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö)

---

## 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑

### 2.1 –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
localtea/
‚îú‚îÄ‚îÄ backend/          # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π API (–ø–æ—Ä—Ç 8000)
‚îú‚îÄ‚îÄ admin_backend/    # –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–π API (–ø–æ—Ä—Ç 8001)
‚îú‚îÄ‚îÄ user_frontend/    # –í–∏—Ç—Ä–∏–Ω–∞ –º–∞–≥–∞–∑–∏–Ω–∞ (Next.js, –ø–æ—Ä—Ç 3000)
‚îú‚îÄ‚îÄ admin_frontend/   # –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (Next.js, –ø–æ—Ä—Ç 3001)
‚îú‚îÄ‚îÄ honeypot/         # –õ–æ–≤—É—à–∫–∞ –¥–ª—è –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫–æ–≤ (–ø–æ—Ä—Ç 8002)
‚îú‚îÄ‚îÄ alembic/          # –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
‚îú‚îÄ‚îÄ tests/            # –¢–µ—Å—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ API
‚îî‚îÄ‚îÄ docker/           # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Docker
```

### 2.2 –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è

**–ü–ª—é—Å—ã:**
- –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è: admin_backend ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å, —á—Ç–æ —É–º–µ–Ω—å—à–∞–µ—Ç –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å –∞—Ç–∞–∫–∏
- CRUD/Service/Schema —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç FastAPI best practices
- Async-first –ø–æ–¥—Ö–æ–¥ (asyncpg, async SQLAlchemy)

**–ú–∏–Ω—É—Å—ã:**
- `admin_backend` –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–æ–¥–µ–ª–∏ –∏–∑ `backend` —á–µ—Ä–µ–∑ Python imports ‚Äî –∂—ë—Å—Ç–∫–∞—è —Å–≤—è–∑–∞–Ω–Ω–æ—Å—Ç—å
- –î–≤–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –æ—Å—Ç–∞—Ç–∫–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤: `SKU.quantity` –∏ `ProductStock.quantity` ‚Äî –≤–æ–∑–º–æ–∂–Ω–∞—è —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
- Celery beat –¥–ª—è –æ—Ç–º–µ–Ω—ã –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥ –±–µ–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
- `doc/` —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–∞–∑—Ä–æ–∑–Ω–µ–Ω–Ω—ã–µ markdown-—Ñ–∞–π–ª—ã –±–µ–∑ –µ–¥–∏–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

---

## 3. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã)

### BUG-001: `NameError` –≤ —ç–Ω–¥–ø–æ–∏–Ω—Ç–µ `/refresh` –ø—Ä–∏ –æ—Ç–∫–ª—é—á—ë–Ω–Ω–æ–º CSRF

**–§–∞–π–ª:** `backend/api/v1/user/endpoints.py`  
**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è ‚Äî –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–∞–¥–∞–µ—Ç —Å `NameError`

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è `expires_at` –æ–±—ä—è–≤–ª—è–ª–∞—Å—å —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ `if token_obj:`, –Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å –Ω–∏–∂–µ –≤ —É—Å–ª–æ–≤–∏–∏ `if not token_obj or token_obj.revoked or expires_at < ...`. –ü—Ä–∏ `CSRF_ENABLED=False` –∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ç–æ–∫–µ–Ω–∞ –≤ –ë–î (`token_obj=None`) –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `expires_at` –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ `NameError`.

```python
# –ë–´–õ–û (–±–∞–≥):
if token_obj:
    expires_at = token_obj.expires_at  # –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –µ—Å–ª–∏ token_obj=None –∏ CSRF –≤—ã–∫–ª—é—á–µ–Ω
    ...
if not token_obj or token_obj.revoked or expires_at < datetime.now(timezone.utc):  # NameError!
    raise HTTPException(...)

# –°–¢–ê–õ–û (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ):
expires_at = None
if token_obj:
    expires_at = token_obj.expires_at
    if expires_at.tzinfo is None:
        expires_at = expires_at.replace(tzinfo=timezone.utc)
if not token_obj or token_obj.revoked or expires_at is None or expires_at < datetime.now(timezone.utc):
    raise HTTPException(...)
```

### BUG-002: –õ–∏—à–Ω–∏–π –∑–∞–ø—Ä–æ—Å –∫ –ë–î –≤ `delete_account`

**–§–∞–π–ª:** `backend/services/user.py`  
**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è ‚Äî –∏–∑–ª–∏—à–Ω—è—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î, –º—ë—Ä—Ç–≤—ã–π –∫–æ–¥

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∞–∫–∫–∞—É–Ω—Ç–∞ –≤—ã–ø–æ–ª–Ω—è–ª—Å—è SELECT –∫ —Ç–∞–±–ª–∏—Ü–µ `Order`, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–æ—Ç–æ—Ä–æ–≥–æ —Å—Ä–∞–∑—É –≤—ã–±—Ä–∞—Å—ã–≤–∞–ª—Å—è. –ó–∞—Ç–µ–º —Ç–æ—Ç –∂–µ SELECT –≤—ã–ø–æ–ª–Ω—è–ª—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ.

```python
# –ë–´–õ–û (–±–∞–≥ ‚Äî –ª–∏—à–Ω–∏–π –∑–∞–ø—Ä–æ—Å):
await db.execute(
    select(Order).where(Order.user_id == user.id)  # —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è!
)
orders = (await db.execute(select(Order).where(Order.user_id == user.id))).scalars().all()

# –°–¢–ê–õ–û (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ):
orders = (await db.execute(select(Order).where(Order.user_id == user.id))).scalars().all()
```

### BUG-003: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–∞—Ç –±–µ–∑ —É—á—ë—Ç–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∑–æ–Ω—ã –≤ `confirm_email_change`

**–§–∞–π–ª:** `backend/services/user.py`  
**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** –í—ã—Å–æ–∫–∞—è ‚Äî `TypeError` –ø—Ä–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏ offset-naive –∏ offset-aware datetime

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–í –º–µ—Ç–æ–¥–µ `confirm_email_change` –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª—Å—è —Å–ª—É—á–∞–π, –∫–æ–≥–¥–∞ `email_confirm_expires_at` —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ë–î –±–µ–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∑–æ–Ω–µ (offset-naive). –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å `datetime.now(timezone.utc)` (offset-aware) –≤—ã–∑—ã–≤–∞–ª–æ `TypeError`.

```python
# –ë–´–õ–û (–±–∞–≥):
if user.email_confirm_expires_at < datetime.now(timezone.utc):  # TypeError –µ—Å–ª–∏ tzinfo=None

# –°–¢–ê–õ–û (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ):
expires_at = user.email_confirm_expires_at
if expires_at is None:
    raise HTTPException(status_code=400, detail="–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Å—Å—ã–ª–∫–∏ –∏—Å—Ç—ë–∫")
if expires_at.tzinfo is None:
    expires_at = expires_at.replace(tzinfo=timezone.utc)
if expires_at < datetime.now(timezone.utc):
    raise HTTPException(status_code=400, detail="–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Å—Å—ã–ª–∫–∏ –∏—Å—Ç—ë–∫")
```

---

## 4. –£—è–∑–≤–∏–º–æ—Å—Ç–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã)

### SEC-001: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ rate limiting –Ω–∞ `/login/access-token`

**–§–∞–π–ª:** `backend/api/v1/user/endpoints.py`  
**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** –í—ã—Å–æ–∫–∞—è ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å brute-force –∞—Ç–∞–∫–∏

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–≠–Ω–¥–ø–æ–∏–Ω—Ç `/login/access-token` (OAuth2 —Ñ–æ—Ä–º–∞) –Ω–µ –∏–º–µ–ª rate limiting, –≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç `/login` (JSON). –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –º–æ–≥ –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ –ø–µ—Ä–µ–±–∏—Ä–∞—Ç—å –ø–∞—Ä–æ–ª–∏ —á–µ—Ä–µ–∑ —ç—Ç–æ—Ç —ç–Ω–¥–ø–æ–∏–Ω—Ç.

```python
# –°–¢–ê–õ–û (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ):
@router.post("/login/access-token", response_model=token_schemas.Token)
@limiter.limit("3/minute")
@limiter.limit("20/hour")
async def login_access_token(...):
```

### SEC-002: OpenAPI/Swagger –¥–æ—Å—Ç—É–ø–µ–Ω –≤ production

**–§–∞–π–ª—ã:** `backend/main.py`, `admin_backend/main.py`  
**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è ‚Äî —Ä–∞—Å–∫—Ä—ã—Ç–∏–µ –¥–µ—Ç–∞–ª–µ–π API –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫–∞–º

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API (Swagger UI, ReDoc) –±—ã–ª–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ production –æ–∫—Ä—É–∂–µ–Ω–∏–∏. –≠—Ç–æ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É API, —Å—Ö–µ–º—ã –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏ –∞—Ç–∞–∫–∏.

```python
# –°–¢–ê–õ–û (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ):
app = FastAPI(
    title=settings.PROJECT_NAME,
    openapi_url=f"/api/v1/openapi.json" if settings.DEBUG else None,
)
```

### SEC-003: –ù–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–≤–∞—Ç–∞—Ä–∞

**–§–∞–π–ª:** `backend/services/user.py`  
**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å DoS —á–µ—Ä–µ–∑ –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–≤–∞—Ç–∞—Ä–∞ –Ω–µ –±—ã–ª–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞. –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –º–æ–≥ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≥–∏–≥–∞–±–∞–π—Ç, –∏—Å—á–µ—Ä–ø–∞–≤ –¥–∏—Å–∫ –∏–ª–∏ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—É—é –ø–∞–º—è—Ç—å —Å–µ—Ä–≤–µ—Ä–∞.

```python
# –°–¢–ê–õ–û (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ):
MAX_FILE_SIZE = 5 * 1024 * 1024  # 5 –ú–ë
file_content = await file.read()
if len(file_content) > MAX_FILE_SIZE:
    raise HTTPException(status_code=413, detail="File too large. Maximum size is 5 MB")
```

---

## 5. –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)

### CODE-001: –£—Å—Ç–∞—Ä–µ–≤—à–∏–π –º–µ—Ç–æ–¥ `.dict()` –≤ Pydantic v2

**–§–∞–π–ª:** `backend/crud/base.py`  
**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è ‚Äî deprecation warning, –º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å—Å—è –≤ –±—É–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–í Pydantic v2 –º–µ—Ç–æ–¥ `.dict()` –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ —É—Å—Ç–∞—Ä–µ–≤—à–∏–π –∏ –∑–∞–º–µ–Ω—ë–Ω –Ω–∞ `.model_dump()`.

```python
# –ë–´–õ–û:
update_data = obj_in.dict(exclude_unset=True)

# –°–¢–ê–õ–û:
update_data = obj_in.model_dump(exclude_unset=True)
```

---

## 6. –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (—Ç—Ä–µ–±—É—é—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)

### ISSUE-001: –õ–∏–º–∏—Ç –ø—Ä–æ–º–æ–∫–æ–¥–∞ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω

**–§–∞–π–ª:** `backend/services/cart.py`  
**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** –í—ã—Å–æ–∫–∞—è ‚Äî –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –ø—Ä–æ–º–æ–∞–∫—Ü–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–í –º–æ–¥–µ–ª–∏ `PromoCode` –µ—Å—Ç—å –ø–æ–ª–µ `usage_limit_per_user = Column(Integer, default=1)`, –æ–¥–Ω–∞–∫–æ –≤ –º–µ—Ç–æ–¥–µ `_get_valid_promo` –µ—Å—Ç—å –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–π TODO:

```python
# TODO: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**  
–°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É `promo_code_usage` –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ —Ç–∞–±–ª–∏—Ü–µ –∑–∞–∫–∞–∑–æ–≤ —Å –¥–∞–Ω–Ω—ã–º –ø—Ä–æ–º–æ–∫–æ–¥–æ–º –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ `user_id` –ø–µ—Ä–µ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º —Å–∫–∏–¥–∫–∏.

---

### ISSUE-002: –°–æ—Å—Ç–æ—è–Ω–∏–µ –≥–æ–Ω–∫–∏ (race condition) –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞

**–§–∞–π–ª:** `backend/services/order.py`  
**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** –í—ã—Å–æ–∫–∞—è ‚Äî –≤–æ–∑–º–æ–∂–Ω–∞ oversell (–ø—Ä–æ–¥–∞–∂–∞ —Å–≤–µ—Ä—Ö –æ—Å—Ç–∞—Ç–∫–∞)

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–ü—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –º–æ–≥—É—Ç –ø—Ä–æ–π—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –æ—Å—Ç–∞—Ç–∫–∞ (`sku.quantity >= –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ`) –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –ª—é–±–æ–π –∏–∑ –Ω–∏—Ö —Å–ø–∏—à–µ—Ç —Ç–æ–≤–∞—Ä. –í –∏—Ç–æ–≥–µ —Ç–æ–≤–∞—Ä –±—É–¥–µ—Ç –ø—Ä–æ–¥–∞–Ω –±–æ–ª—å—à–µ —Ä–∞–∑, —á–µ–º –µ—Å—Ç—å –Ω–∞ —Å–∫–ª–∞–¥–µ.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**  
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Å—Å–∏–º–∏—Å—Ç–∏—á–µ—Å–∫—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É —Å—Ç—Ä–æ–∫–∏ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –æ—Å—Ç–∞—Ç–∫–∞:
```python
from sqlalchemy import select
from sqlalchemy.dialects.postgresql import FOR UPDATE

result = await db.execute(
    select(SKU).where(SKU.id == sku_id).with_for_update()
)
```

---

### ISSUE-003: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤

**–§–∞–π–ª—ã:** `backend/models/catalog.py`, `backend/models/inventory.py`  
**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è ‚Äî —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–¢–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫ —Ç–æ–≤–∞—Ä–∞ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö:
- `SKU.quantity` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –∏ –∫–æ—Ä–∑–∏–Ω—ã
- `ProductStock.quantity` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Å–∏—Å—Ç–µ–º–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∫–ª–∞–¥–æ–º

–ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–µ–∂–¥—É –Ω–∏–º–∏, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**  
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É —Ç–∞–±–ª–∏—Ü—É (`ProductStock`) –∫–∞–∫ –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –∏ –æ–±–Ω–æ–≤–ª—è—Ç—å `SKU.quantity` —á–µ—Ä–µ–∑ —Ç—Ä–∏–≥–≥–µ—Ä –∏–ª–∏ —É–±—Ä–∞—Ç—å —ç—Ç–æ –ø–æ–ª–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é.

---

### ISSUE-004: X-Forwarded-For –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–¥–¥–µ–ª–∞–Ω –¥–ª—è –æ–±—Ö–æ–¥–∞ IP-–≤–∞–π—Ç–ª–∏—Å—Ç–∞ –ÆKassa

**–§–∞–π–ª:** `backend/utils/client_info.py`  
**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** –í—ã—Å–æ–∫–∞—è –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–µ ‚Äî –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ trusted proxy

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–§—É–Ω–∫—Ü–∏—è `get_client_ip` –±–µ—Ä—ë—Ç –ø–µ—Ä–≤—ã–π IP –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ `X-Forwarded-For` –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏, –∏—Å—Ö–æ–¥–∏—Ç –ª–∏ –æ–Ω –æ—Ç –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–∫—Å–∏. –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫ –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-Forwarded-For: 185.71.76.1` (IP –ÆKassa) –∏ –æ–±–æ–π—Ç–∏ IP-–≤–∞–π—Ç–ª–∏—Å—Ç webhook'–∞.

```
–ó–∞–ø—Ä–æ—Å –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫–∞:
GET /api/v1/webhooks/payment/yookassa HTTP/1.1
X-Forwarded-For: 185.71.76.1
# —Ä–µ–∞–ª—å–Ω—ã–π IP –∑–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è –¥–∞–ª—å—à–µ –≤ —Ü–µ–ø–æ—á–∫–µ
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**  
–í Nginx –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å `set_real_ip_from` –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –ø—Ä–æ–∫—Å–∏ –∏ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π IP. –õ–∏–±–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `request.client.host` –Ω–∞–ø—Ä—è–º—É—é (–±–µ–∑ `X-Forwarded-For`) –≤ webhook-—ç–Ω–¥–ø–æ–∏–Ω—Ç–µ, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –∑–∞ –∏–∑–≤–µ—Å—Ç–Ω—ã–º –ø—Ä–æ–∫—Å–∏.

---

### ISSUE-005: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ `get_client_ip`

**–§–∞–π–ª—ã:** `backend/utils/client_info.py`, `backend/api/v1/webhooks/endpoints.py`  
**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è ‚Äî –Ω–∞—Ä—É—à–µ–Ω–∏–µ DRY, —Ä–∏—Å–∫ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è –ª–æ–≥–∏–∫–∏

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–§—É–Ω–∫—Ü–∏—è `get_client_ip` –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤ –¥–≤—É—Ö –º–µ—Å—Ç–∞—Ö —Å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑–Ω–æ–π –ª–æ–≥–∏–∫–æ–π. –í `webhooks/endpoints.py` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ `X-Forwarded-For`, –±–µ–∑ `X-Real-IP`.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**  
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –∏–∑ `backend/utils/client_info.py` –≤ –æ–±–æ–∏—Ö –º–µ—Å—Ç–∞—Ö.

---

### ISSUE-006: CSRF-—Ç–æ–∫–µ–Ω –≤ `get_current_user_with_csrf` –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —Å–µ—Å—Å–∏–∏

**–§–∞–π–ª:** `backend/dependencies/deps.py`  
**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è CSRF-—Ç–æ–∫–µ–Ω–∞ –æ—Ç –¥—Ä—É–≥–æ–π —Å–µ—Å—Å–∏–∏

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ `get_current_user_with_csrf` CSRF-—Ç–æ–∫–µ–Ω –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø–æ–¥–ø–∏—Å–∏ (HMAC), –Ω–æ –Ω–µ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç—Å—è —Å —Ç–æ–∫–µ–Ω–æ–º, —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–º –≤ –∑–∞–ø–∏—Å–∏ Token –≤ –ë–î. –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –ª—é–±–æ–π –≤–∞–ª–∏–¥–Ω—ã–π CSRF-—Ç–æ–∫–µ–Ω (–Ω–µ —Ç–æ–ª—å–∫–æ –≤—ã–¥–∞–Ω–Ω—ã–π —Å —Ç–µ–∫—É—â–∏–º refresh-—Ç–æ–∫–µ–Ω–æ–º) —Å—á–∏—Ç–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º.

–°—Ä–∞–≤–Ω–∏—Ç–µ —Å —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–º `/refresh`, –∫–æ—Ç–æ—Ä—ã–π –¥–µ–ª–∞–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É:
```python
if not token_obj or token_obj.csrf_token != csrf_token_header:
    raise HTTPException(status_code=403, detail="Invalid CSRF session")
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**  
–í `get_current_user_with_csrf` –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å, —á—Ç–æ CSRF-—Ç–æ–∫–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–∫—É—â–µ–π –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ—Å—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ Token.

---

### ISSUE-007: –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è

**–§–∞–π–ª:** `backend/schemas/user.py`  
**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–∞–±—ã–µ –ø–∞—Ä–æ–ª–∏

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–ª–∏–Ω—É (8 —Å–∏–º–≤–æ–ª–æ–≤). –ù–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ –Ω–∞–ª–∏—á–∏—é —Ü–∏—Ñ—Ä, –∑–∞–≥–ª–∞–≤–Ω—ã—Ö –±—É–∫–≤, —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤.

```python
@field_validator('password')
@classmethod
def password_complexity(cls, v: str) -> str:
    if len(v) < 8:
        raise ValueError('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –∫–æ—Ä–æ—á–µ 8 —Å–∏–º–≤–æ–ª–æ–≤')
    # Add more complexity checks if needed  ‚Üê –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å!
    return v
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**  
–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ü–∏—Ñ—Ä—É –∏ –æ–¥–Ω—É –±—É–∫–≤—É, –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É `zxcvbn` –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è.

---

### ISSUE-008: PGAdmin –æ—Ç–∫—Ä—ã—Ç —Å –ø–∞—Ä–æ–ª–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ docker-compose.yml

**–§–∞–π–ª:** `docker-compose.yml`  
**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è –¥–ª—è dev ‚Äî –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –µ—Å–ª–∏ –ø–æ–ø–∞–¥—ë—Ç –≤ production

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
PGAdmin –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 8003 —Å –ø–∞—Ä–æ–ª–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `admin`:
```yaml
pgadmin:
  environment:
    - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_DEFAULT_PASSWORD:-admin}
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**  
–£–±—Ä–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `:-admin`. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∑—ã–≤–∞—Ç—å `PGADMIN_DEFAULT_PASSWORD` –≤ `.env`.

---

### ISSUE-009: Celery task –Ω–µ –∏–º–µ–µ—Ç distributed lock –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤

**–§–∞–π–ª:** `backend/worker.py`, `backend/core/celery_app.py`  
**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è ‚Äî –¥–≤–æ–π–Ω–∞—è –æ—Ç–º–µ–Ω–∞ –∑–∞–∫–∞–∑–æ–≤ –ø—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–æ—Ä–∫–µ—Ä–∞—Ö

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
Celery Beat –≤—ã–∑—ã–≤–∞–µ—Ç `check_expired_orders` –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥. –ü—Ä–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–æ—Ä–∫–µ—Ä–∞—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –º–æ–≥—É—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –∑–∞–∫–∞–∑—ã.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**  
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `celery-redbeat` –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –∏–ª–∏ Redis-–±–ª–æ–∫–∏—Ä–æ–≤–∫—É –≤–Ω—É—Ç—Ä–∏ –∑–∞–¥–∞—á–∏.

---

### ISSUE-010: –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –ª–æ–≥–∞—Ö

**–§–∞–π–ª:** `backend/api/v1/user/endpoints.py`  
**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è ‚Äî –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –ª–æ–≥–∞—Ö

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
```python
logger.info(f"Upload avatar request: filename={file.filename}, content_type={file.content_type}, size={file.size}")
```

–•–æ—Ç—è —ç—Ç–æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ª–æ–≥ –±–µ–∑–≤—Ä–µ–¥–µ–Ω, –≤ `services/user.py` –∏ –¥—Ä—É–≥–∏—Ö —Ñ–∞–π–ª–∞—Ö –º–æ–≥—É—Ç –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å—Å—è email-–∞–¥—Ä–µ—Å–∞. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∞—É–¥–∏—Ç –≤—Å–µ—Ö `logger.*` –≤—ã–∑–æ–≤–æ–≤ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç –ü–î–Ω.

---

### ISSUE-011: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ health-check –¥–ª—è admin_backend –≤ production

**–§–∞–π–ª:** `docker-compose.prod.yml`  
**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è ‚Äî –Ω–µ—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
–î–ª—è `backend` –Ω–∞—Å—Ç—Ä–æ–µ–Ω healthcheck, –Ω–æ –¥–ª—è `admin_backend` –æ–Ω –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.

---

### ISSUE-012: –ó–∞–≥–æ–ª–æ–≤–æ–∫ `cookie` `samesite="lax"` ‚Äî —É—è–∑–≤–∏–º–æ—Å—Ç—å –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö Safari

**–§–∞–π–ª:** `backend/api/v1/user/endpoints.py`  
**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è `strict` –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∫—É–∫

**–û–ø–∏—Å–∞–Ω–∏–µ:**  
Refresh-—Ç–æ–∫–µ–Ω –∏ CSRF-—Ç–æ–∫–µ–Ω —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è —Å `samesite="lax"`. –ó–Ω–∞—á–µ–Ω–∏–µ `strict` –±—É–¥–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã—Ö –∫—É–∫, —Ö–æ—Ç—è `lax` —Ç–æ–∂–µ –ø—Ä–∏–µ–º–ª–µ–º–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ CSRF-–∑–∞—â–∏—Ç—ã.

---

## 7. –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ä–µ–ª–∏–∑—É

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –°—Ç–∞—Ç—É—Å | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|-----------|--------|-------------|
| –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π | ‚úÖ –ì–æ—Ç–æ–≤–æ | JWT + CSRF + refresh tokens |
| –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ | ‚úÖ –ì–æ—Ç–æ–≤–æ | TOTP 2FA —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ |
| –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤ | ‚ö†Ô∏è –ù–µ –≥–æ—Ç–æ–≤–æ | Race condition –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–∫–∞–∑–∞—Ö |
| –û–ø–ª–∞—Ç–∞ (–ÆKassa) | ‚úÖ –ì–æ—Ç–æ–≤–æ | HMAC-–ø–æ–¥–ø–∏—Å—å, IP-–≤–∞–π—Ç–ª–∏—Å—Ç |
| –ü—Ä–æ–º–æ–∫–æ–¥—ã | ‚ö†Ô∏è –ù–µ –≥–æ—Ç–æ–≤–æ | –õ–∏–º–∏—Ç –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω |
| –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–æ–º | ‚ö†Ô∏è –ù–µ –≥–æ—Ç–æ–≤–æ | –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö SKU/ProductStock |
| –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å API | ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏ | Rate limit, OpenAPI ‚Äî –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã; CSRF binding, X-FF ‚Äî –Ω–µ—Ç |
| –¢–µ—Å—Ç—ã | ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ | –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ø–æ–∫—Ä—ã—Ç—ã, –Ω–µ—Ç e2e |
| CI/CD | ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç | –ù–µ—Ç GitHub Actions –¥–ª—è –∞–≤—Ç–æ—Ç–µ—Å—Ç–æ–≤ |
| –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ | ‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç | –ù–µ—Ç Prometheus/Grafana/Sentry |
| –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è | ‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ | –û—Ç–¥–µ–ª—å–Ω—ã–µ markdown-—Ñ–∞–π–ª—ã, –Ω–µ—Ç –æ–±—â–µ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ |

**–í—ã–≤–æ–¥:** –ü—Ä–æ–µ–∫—Ç **–Ω–µ –≥–æ—Ç–æ–≤ –∫ production-—Ä–µ–ª–∏–∑—É**. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –º–∏–Ω–∏–º—É–º ISSUE-001 (–ø—Ä–æ–º–æ–∫–æ–¥—ã), ISSUE-002 (race condition), ISSUE-004 (IP-—Å–ø—É—Ñ–∏–Ω–≥), –∞ —Ç–∞–∫–∂–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å CI/CD –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥.

---

## 8. –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 ‚Äî –ö—Ä–∏—Ç–∏—á–Ω–æ (–¥–æ —Ä–µ–ª–∏–∑–∞)

| # | –ó–∞–¥–∞—á–∞ | –§–∞–π–ª | –°—Ç–∞—Ç—É—Å |
|---|--------|------|--------|
| 1 | ~~–ò—Å–ø—Ä–∞–≤–∏—Ç—å `NameError` –≤ `/refresh`~~ | `backend/api/v1/user/endpoints.py` | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| 2 | ~~–ò—Å–ø—Ä–∞–≤–∏—Ç—å –ª–∏—à–Ω–∏–π –∑–∞–ø—Ä–æ—Å –≤ `delete_account`~~ | `backend/services/user.py` | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| 3 | ~~–ò—Å–ø—Ä–∞–≤–∏—Ç—å `TypeError` –≤ `confirm_email_change`~~ | `backend/services/user.py` | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| 4 | ~~–î–æ–±–∞–≤–∏—Ç—å rate limiting –Ω–∞ `/login/access-token`~~ | `backend/api/v1/user/endpoints.py` | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| 5 | ~~–°–∫—Ä—ã—Ç—å OpenAPI –≤ production~~ | `backend/main.py`, `admin_backend/main.py` | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| 6 | –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–∏–º–∏—Ç –ø—Ä–æ–º–æ–∫–æ–¥–∞ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è | `backend/services/cart.py` | üî¥ –¢—Ä–µ–±—É–µ—Ç—Å—è |
| 7 | –î–æ–±–∞–≤–∏—Ç—å pessimistic lock –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ | `backend/services/order.py` | üî¥ –¢—Ä–µ–±—É–µ—Ç—Å—è |
| 8 | –ò—Å–ø—Ä–∞–≤–∏—Ç—å X-Forwarded-For spoofing –≤ webhook | `backend/utils/client_info.py` + Nginx | üî¥ –¢—Ä–µ–±—É–µ—Ç—Å—è |

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 ‚Äî –í–∞–∂–Ω–æ (–≤ —Ç–µ—á–µ–Ω–∏–µ 2-—Ö –Ω–µ–¥–µ–ª—å)

| # | –ó–∞–¥–∞—á–∞ | –§–∞–π–ª | –°—Ç–∞—Ç—É—Å |
|---|--------|------|--------|
| 9 | ~~–î–æ–±–∞–≤–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ –∞–≤–∞—Ç–∞—Ä–∞~~ | `backend/services/user.py` | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| 10 | ~~–ò—Å–ø—Ä–∞–≤–∏—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏–π `.dict()`~~ | `backend/crud/base.py` | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| 11 | –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏–π—Å—è `get_client_ip` | `backend/api/v1/webhooks/endpoints.py` | üü° –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è |
| 12 | –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–≤—è–∑–∫—É CSRF –∫ —Å–µ—Å—Å–∏–∏ –≤ `get_current_user_with_csrf` | `backend/dependencies/deps.py` | üü° –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è |
| 13 | –£–ª—É—á—à–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è | `backend/schemas/user.py` | üü° –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è |
| 14 | –£–±—Ä–∞—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –ø–∞—Ä–æ–ª—å PGAdmin | `docker-compose.yml` | üü° –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è |

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 ‚Äî –•–æ—Ä–æ—à–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ (–¥–æ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞)

| # | –ó–∞–¥–∞—á–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---|--------|----------|
| 15 | –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CI/CD | GitHub Actions: —Ç–µ—Å—Ç—ã + –ª–∏–Ω—Ç–µ—Ä –ø—Ä–∏ –∫–∞–∂–¥–æ–º PR |
| 16 | –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ | Sentry –¥–ª—è –æ—à–∏–±–æ–∫, Prometheus + Grafana –¥–ª—è –º–µ—Ç—Ä–∏–∫ |
| 17 | –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ | –û–¥–∏–Ω –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã: `ProductStock` |
| 18 | –î–æ–±–∞–≤–∏—Ç—å distributed lock –≤ Celery –∑–∞–¥–∞—á—É | –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –¥–≤–æ–π–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ |
| 19 | Healthcheck –¥–ª—è admin_backend | `docker-compose.prod.yml` |
| 20 | –ê—É–¥–∏—Ç –ª–æ–≥–æ–≤ –Ω–∞ –ü–î–Ω | –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ email/—Ç–µ–ª–µ—Ñ–æ–Ω—ã –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –ª–æ–≥–∏ |
