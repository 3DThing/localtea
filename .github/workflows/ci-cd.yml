# ──────────────────────────────────────────────────────────────────
# LocalTea CI/CD – тесты + деплой
# ──────────────────────────────────────────────────────────────────
#
# Workflow запускается:
#   • на каждый push / PR в main
#   • вручную через workflow_dispatch
#
# Деплой происходит ТОЛЬКО при push в main (после прохождения тестов).
#
# Необходимые GitHub Secrets:
#   DEPLOY_HOST        – IP или домен сервера
#   DEPLOY_USER        – SSH-пользователь (например root)
#   DEPLOY_SSH_KEY     – приватный SSH-ключ
#   DEPLOY_PATH        – путь к проекту на сервере (/root/LocalTea)
# ──────────────────────────────────────────────────────────────────

name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.10"
  NODE_VERSION: "20"

# ───────────────────────────── Jobs ────────────────────────────────

jobs:
  # ────────────── 1. Lint & Test (Backend) ─────────────────────────
  test-backend:
    name: Backend Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: localtea_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          if [ -f admin_backend/requirements.txt ]; then
            pip install -r admin_backend/requirements.txt
          fi

      - name: Run tests
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_HOST: localhost
          POSTGRES_PORT: 5432
          POSTGRES_DB: localtea_test
          DATABASE_URL: postgresql+asyncpg://postgres:postgres@localhost:5432/localtea_test
          REDIS_URL: redis://localhost:6379/0
          SECRET_KEY: ci-test-secret-key
          CSRF_SECRET_KEY: ci-test-csrf-key
          TOTP_ENCRYPTION_KEY: dGVzdC10b3RwLWVuY3J5cHRpb24ta2V5LTMyYg==
          SMTP_SERVER: smtp.example.com
          SMTP_USER: test@example.com
          SMTP_PASSWORD: test-password
          EMAILS_FROM_EMAIL: test@example.com
          UPLOAD_DIR: /tmp/localtea-uploads
          TESTING: "1"
        run: |
          pytest tests/ -v --tb=short -q

  # ────────────── 2. Lint (Frontend) ──────────────────────────────
  lint-frontend:
    name: Frontend Lint
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app: [user_frontend, admin_frontend]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: ${{ matrix.app }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ matrix.app }}
        run: npm ci

      - name: Lint
        working-directory: ${{ matrix.app }}
        run: npm run lint --if-present

      - name: Type check
        working-directory: ${{ matrix.app }}
        run: npx tsc --noEmit --pretty || true

  # ────────────── 3. Build images (проверка сборки) ────────────────
  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [test-backend, lint-frontend]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend (prod stage)
        uses: docker/build-push-action@v5
        with:
          context: .
          target: prod
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build admin_backend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: admin_backend/Dockerfile
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build user_frontend
        uses: docker/build-push-action@v5
        with:
          context: ./user_frontend
          push: false
          build-args: |
            NEXT_PUBLIC_API_URL=https://api.localtea.ru
            NEXT_PUBLIC_HONEYPOT_API=https://api.localtea.ru
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build admin_frontend
        uses: docker/build-push-action@v5
        with:
          context: ./admin_frontend
          file: ./admin_frontend/Dockerfile.prod
          push: false
          build-args: |
            NEXT_PUBLIC_API_URL=https://apiadmin.localtea.ru/api/v1
            NEXT_PUBLIC_AI_API_URL=https://apiadmin.localtea.ru/ai/api/v1/admin/assistant
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ────────────── 4. Deploy ────────────────────────────────────────
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-images]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    concurrency:
      group: deploy-production
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Deploy
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "cd ${{ secrets.DEPLOY_PATH }} && bash scripts/deploy.sh"

      - name: Health check
        run: |
          echo "Waiting for services to start..."
          sleep 20
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "curl -sf http://localhost:8000/health || echo 'WARNING: Health check failed'"

      - name: Cleanup SSH
        if: always()
        run: rm -f ~/.ssh/deploy_key
